<!DOCTYPE html>
<html>
<head>
    <title>ì›¹ê²Œì„ ì±„íŒ…ì°½</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #2e2e2e; font-family: 'Malgun Gothic', sans-serif; box-sizing: border-box; }
        #wrapper { display: flex; width: 100%; height: 100%; position: relative; }
        #chat-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1f1f1f; }
        
        /* ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ ë° ë©”ì‹œì§€ ë””ìì¸ */
        #messages { flex: 1; overflow-y: auto; margin: 0; padding: 4px; list-style-type: none; font-size: 13px; color: #ddd; }
        #messages li { padding: 3px 4px; margin-bottom: 0; word-break: break-all; border-radius: 0; transition: background-color 0.1s; position: relative; } 
        /* â˜… ë³µêµ¬ 1. ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì‚´ì§ ë°ì•„ì§€ëŠ” íš¨ê³¼ */
        #messages li:hover { background-color: #3d3d3d; }
        
        .my-message-bg { background-color: #242424; }
        .user-icon { width: 12px; height: 12px; margin-right: 3px; vertical-align: middle; border-radius: 2px; }
        .my-nickname { color: #5dade2; font-weight: bold; }   
        .other-nickname { color: #dfdfdf; font-weight: bold; } 
        .msg-text { color: #dfdfdf; }
        .chat-emoticon { width: 40px; height: 40px; vertical-align: middle; }
        .clickable-nick { cursor: pointer; }
        .whisper-msg { color: #ff9ff3; font-weight: bold; }

        /* í•˜ë‹¨ ì…ë ¥ì°½ */
        #form { display: flex; padding: 0 4px; background: #3a3a3a; align-items: center; height: 30px; }
        #emo-toggle-btn { width: 26px; height: 100%; background: transparent; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        #input { flex: 1; padding: 0 4px; background: transparent; border: none; color: #eee; height: 100%; font-size: 13px; outline: none; }
        #form button[type="submit"] { background: transparent; color: #999; border: none; cursor: pointer; font-weight: bold; }

        /* ì´ëª¨í‹°ì½˜ íŒì—… */
        #emo-picker { position: absolute; bottom: 32px; left: 4px; width: 185px; background: #333; border: 1px solid #111; display: none; flex-direction: column; z-index: 100; }
        #emo-list { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; padding: 4px; height: 75px; overflow: hidden; }
        #emo-list img { width: 34px; height: 34px; cursor: pointer; }
        #emo-pagination { display: flex; justify-content: space-between; align-items: center; padding: 2px 5px; background: #222; font-size: 10px; color: #ccc; }
        #emo-pagination button { background: #444; border: none; color: #fff; cursor: pointer; padding: 0 4px; }

        /* ìƒíƒœì°½(ìœ ì € íŒì—…) */
        #user-popup { position: absolute; background: rgba(35,35,35,0.98); border: 1px solid #444; display: none; flex-direction: column; z-index: 101; min-width: 90px; }
        #user-popup button { background: transparent; color: #eee; border: none; padding: 7px 10px; font-size: 12px; cursor: pointer; text-align: left; }
        #user-popup button:hover { background: #4a90e2; }
        .admin-btn { display: none; }

        /* ìš°ì¸¡ ìœ ì € ëª©ë¡ */
        #user-list-container { width: 150px; display: flex; flex-direction: column; background: #2e2e2e; }
        #users { flex: 1; overflow-y: auto; list-style: none; padding: 5px; margin: 0; font-size: 12px; color: #ddd; }
        #users li { padding: 2px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; }

        /* â˜… ë³µêµ¬ 2. ì‹œê°„ í‘œì‹œ íˆ´íŒ ë””ìì¸ */
        #time-tooltip { position: absolute; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; pointer-events: none; z-index: 9999; display: none; white-space: nowrap; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="chat-container">
            <ul id="messages"></ul>
            <div id="emo-picker">
                <div id="emo-list"></div>
                <div id="emo-pagination">
                    <button id="emo-prev">â—€</button>
                    <span id="emo-page-info">1 / 1</span>
                    <button id="emo-next">â–¶</button>
                </div>
            </div>
            <div id="user-popup">
                <button id="btn-whisper">ê·“ì†ë§</button>
                <button id="btn-call" style="color:#ffd32a;">í˜¸ì¶œí•˜ê¸°</button>
                <button id="btn-mute" class="admin-btn" style="color:#ff6b6b;">ì°¨ë‹¨</button>
                <button id="btn-unmute" class="admin-btn" style="color:#51cf66;">í•´ì œ</button>
                <button id="btn-clear" class="admin-btn" style="color:#fcc419;">ì²­ì†Œ</button>
            </div>
            <form id="form" onsubmit="return false;">
                <button id="emo-toggle-btn" type="button">+</button>
                <input id="input" placeholder="ì±„íŒ….." autocomplete="off" />
                <button type="submit">ì „ì†¡</button>
            </form>
        </div>
        <div id="user-list-container">
            <ul id="users"></ul>
        </div>
    </div>

    <audio id="call-sound" src="/call.mp3" preload="auto"></audio>
    <div id="time-tooltip"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const myNick = urlParams.get('nick') || 'Guest_' + Math.floor(Math.random() * 100);
        const myId = urlParams.get('id') || 'guest';
        let myIcon = urlParams.get('icon') || urlParams.get('con') || '';
        
        const fixPath = (p) => (p.startsWith('.') || p.startsWith('/')) ? 'http://forceofd.org/dt/' + p.replace(/^\.?\//, '') : p;
        myIcon = fixPath(myIcon);

        const myInfo = { nick: myNick, id: myId, icon: myIcon };

        let isAdmin = false; 
        socket.on('admin auth', () => { isAdmin = true; });

        const localMutedIds = new Set();
        const callCooldowns = {};

        socket.emit('join', myInfo);

        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const userPopup = document.getElementById('user-popup');
        const emoPicker = document.getElementById('emo-picker');
        const timeTooltip = document.getElementById('time-tooltip');
        let selectedUser = { nick: '', id: '' };

        function displayMessage(data, isWhisper = false, whisperPrefix = "") {
            const item = document.createElement('li');
            if (data.user.nick === myNick) item.classList.add('my-message-bg');

            // â˜… íˆ´íŒì„ ìœ„í•´ ë°ì´í„° ê¸°ë¡ (ë¹¼ë¨¹ì—ˆë˜ ë¶€ë¶„ ë³µêµ¬)
            item.setAttribute('data-time', data.timestamp || Date.now());
            item.setAttribute('data-nick', data.user.nick);

            const iconHtml = data.user.icon ? `<img src="${fixPath(data.user.icon)}" class="user-icon" onerror="this.style.display='none'">` : '';
            const nickClass = (data.user.nick === myNick) ? 'my-nickname' : 'other-nickname';
            const contentHtml = (data.type === 'image') ? `<img src="${data.content}" class="chat-emoticon">` : `<span class="msg-text">${data.content}</span>`;

            item.innerHTML = isWhisper 
                ? `<span class="whisper-msg">${whisperPrefix}</span> <span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> ${contentHtml}`
                : `${iconHtml}<span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> ${contentHtml}`;

            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        socket.on('chat history', (h) => { h.forEach(d => displayMessage(d)); });
        socket.on('chat message', (d) => displayMessage(d));
        socket.on('whisper', (d) => {
            const prefix = (d.user.nick === myNick) ? `[To ${d.targetNick}]` : `[From ${d.user.nick}]`;
            displayMessage(d, true, prefix);
        });

        socket.on('call alert', (data) => {
            const audio = document.getElementById('call-sound');
            audio.play().catch(e => console.log('ì†Œë¦¬ ì¬ìƒ ì°¨ë‹¨ë¨:', e)); 
            const item = document.createElement('li');
            item.innerHTML = `<span style="color:#ffd32a; font-weight:bold;">[í˜¸ì¶œ] ğŸ”” ${data.sender}ë‹˜ì´ ë‹¹ì‹ ì„ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤!</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('system message', (msg) => {
            const item = document.createElement('li');
            item.innerHTML = `<span class="system-msg">${msg}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('clear chat', () => { messages.innerHTML = ''; });
        socket.on('disconnect', () => { setTimeout(() => location.reload(), 2000); });

        socket.on('user list', (users) => {
            const list = document.getElementById('users');
            list.innerHTML = '';
            users.sort((a, b) => {
                if (a.isAdmin && !b.isAdmin) return -1;
                if (!a.isAdmin && b.isAdmin) return 1;
                return 0; 
            }).forEach(u => {
                const li = document.createElement('li');
                const isMe = (u.nick === myNick);
                const crown = u.isAdmin ? 'ğŸ‘‘' : '';
                const icon = u.icon ? `<img src="${fixPath(u.icon)}" class="user-icon">` : '';
                li.innerHTML = `${crown}${icon}<span class="clickable-nick" data-nick="${u.nick}" data-id="${u.id}" style="color:${isMe ? '#5dade2' : '#dfdfdf'};">${u.nick}</span>`;
                list.appendChild(li);
            });
        });

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = input.value.trim();
            if(!val) return;
            if (val.startsWith('/w ')) {
                const p = val.split(' ');
                if (p.length > 2) socket.emit('whisper', { targetNick: p[1], user: myInfo, content: p.slice(2).join(' ') });
            } else {
                socket.emit('chat message', { type: 'text', user: myInfo, content: val });
            }
            input.value = '';
            emoPicker.style.display = 'none';
        };

        // â˜… ë³µêµ¬ 3. íŒì—… ìœ„ì¹˜ ì •ë°€í•˜ê²Œ ìŠ¤ë§ˆíŠ¸ ì „í™˜
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('clickable-nick')) {
                const nick = e.target.getAttribute('data-nick');
                if (nick === myNick) return;
                selectedUser = { nick: nick, id: e.target.getAttribute('data-id') };
                
                document.getElementById('btn-mute').style.display = 'none';
                document.getElementById('btn-unmute').style.display = 'none';
                document.getElementById('btn-clear').style.display = 'none';

                if (isAdmin) {
                    const isMuted = localMutedIds.has(selectedUser.id);
                    document.getElementById('btn-mute').style.display = isMuted ? 'none' : 'block';
                    document.getElementById('btn-unmute').style.display = isMuted ? 'block' : 'none';
                    document.getElementById('btn-clear').style.display = 'block';
                }
                
                // ë””ìŠ¤í”Œë ˆì´ë¥¼ ì¼œì•¼ í¬ê¸°(offsetWidth)ë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
                userPopup.style.display = 'flex';
                
                // ë§ˆìš°ìŠ¤ í´ë¦­ ìœ„ì¹˜ ë°”ë¡œ ìš°ì¸¡ í•˜ë‹¨ ê¸°ì¤€
                let x = e.pageX + 10;
                let y = e.pageY + 10;
                
                const popW = userPopup.offsetWidth;
                const popH = userPopup.offsetHeight;

                // ì§¤ë¦¼ ë°©ì§€: í™”ë©´ ìš°ì¸¡/í•˜ë‹¨ì„ ë„˜ì–´ê°€ë©´ ë°˜ëŒ€ìª½(ì¢Œì¸¡/ìƒë‹¨)ìœ¼ë¡œ ë’¤ì§‘ê¸°
                if (x + popW > window.innerWidth) x = e.pageX - popW - 10;
                if (y + popH > window.innerHeight) y = e.pageY - popH - 10;

                userPopup.style.left = x + 'px';
                userPopup.style.top = y + 'px';
            } else if (!userPopup.contains(e.target)) {
                userPopup.style.display = 'none';
            }
        });

        // â˜… ë³µêµ¬ 4. ì±„íŒ… ì‹œê°„ íˆ´íŒ ì´ë²¤íŠ¸ ë¡œì§ (0.7ì´ˆ)
        function formatTimeDiff(timestamp) {
            const diffMins = Math.floor((Date.now() - timestamp) / 60000);
            if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
            if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
            return `${Math.floor(diffHours / 24)}ì¼ ì „`;
        }

        let tooltipTimeout;
        let mouseX = 0, mouseY = 0;

        function updateTooltipPosition() {
            let pw = timeTooltip.offsetWidth;
            let ph = timeTooltip.offsetHeight;
            let x = mouseX + 15;
            let y = mouseY + 15;
            
            if (x + pw > window.innerWidth) x = mouseX - pw - 10;
            if (y + ph > window.innerHeight) y = mouseY - ph - 10;
            if (y < 0) y = 5;

            timeTooltip.style.left = x + 'px';
            timeTooltip.style.top = y + 'px';
        }

        messages.addEventListener('mousemove', (e) => {
            mouseX = e.pageX; mouseY = e.pageY;
            if (timeTooltip.style.display === 'block') updateTooltipPosition();
        });

        messages.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li');
            if (li && li.hasAttribute('data-time')) {
                const sendNick = li.getAttribute('data-nick') || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const timeStr = formatTimeDiff(parseInt(li.getAttribute('data-time')));
                tooltipTimeout = setTimeout(() => {
                    timeTooltip.innerText = `${sendNick} ${timeStr}`;
                    timeTooltip.style.display = 'block';
                    updateTooltipPosition(); 
                }, 700); // 0.7ì´ˆ ëŒ€ê¸°
            }
        });

        messages.addEventListener('mouseout', (e) => {
            if (e.target.closest('li')) {
                clearTimeout(tooltipTimeout);
                timeTooltip.style.display = 'none';
            }
        });

        // ì´ëª¨í‹°ì½˜ ë° ë²„íŠ¼ ë¡œì§
        let emos = []; let pg = 1;
        const drawEmos = () => {
            const list = document.getElementById('emo-list');
            list.innerHTML = '';
            emos.slice((pg-1)*10, pg*10).forEach(f => {
                const img = document.createElement('img');
                img.src = `/emoticons/${f}`;
                img.onclick = () => { socket.emit('chat message', { type:'image', user:myInfo, content:img.src }); emoPicker.style.display='none'; };
                list.appendChild(img);
            });
            document.getElementById('emo-page-info').innerText = `${pg}/${Math.ceil(emos.length/10)}`;
        };

        fetch('/api/emoticons').then(r => r.json()).then(f => { emos = f; drawEmos(); });
        document.getElementById('emo-toggle-btn').onclick = () => emoPicker.style.display = (emoPicker.style.display==='flex'?'none':'flex');
        document.getElementById('emo-prev').onclick = () => { if(pg>1){ pg--; drawEmos(); } };
        document.getElementById('emo-next').onclick = () => { if(pg < emos.length/10){ pg++; drawEmos(); } };

        document.getElementById('btn-whisper').onclick = () => { input.value = `/w ${selectedUser.nick} `; input.focus(); userPopup.style.display='none'; };
        
        document.getElementById('btn-call').onclick = () => {
            const now = Date.now();
            const lastCallTime = callCooldowns[selectedUser.id];
            
            if (lastCallTime && (now - lastCallTime < 600000)) {
                const item = document.createElement('li');
                item.innerHTML = `<span class="system-msg">[ì•ˆë‚´] ê°™ì€ ëŒ€ìƒì€ 10ë¶„ì— í•œ ë²ˆë§Œ í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>`;
                messages.appendChild(item);
                messages.scrollTop = messages.scrollHeight;
            } else {
                callCooldowns[selectedUser.id] = now;
                socket.emit('call user', { targetNick: selectedUser.nick, sender: myNick });
            }
            userPopup.style.display='none';
        };

        document.getElementById('btn-mute').onclick = () => { socket.emit('mute user', selectedUser.id); localMutedIds.add(selectedUser.id); userPopup.style.display='none'; };
        document.getElementById('btn-unmute').onclick = () => { socket.emit('unmute user', selectedUser.id); localMutedIds.delete(selectedUser.id); userPopup.style.display='none'; };
        document.getElementById('btn-clear').onclick = () => { socket.emit('clear chat'); userPopup.style.display='none'; };
    </script>
</body>
</html>


