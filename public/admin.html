<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dtactics Admin Panel</title>
    <style>
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #2e2e2e; color: #ddd; 
            font-family: 'Malgun Gothic', sans-serif; 
        }
        .container { 
            max-width: 1100px; margin: 30px auto; padding: 25px; 
            background: #333; border: 1px solid #1f1f1f; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .admin-stats { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-box { 
            flex: 1; background: #252525; border: 1px solid #444; 
            padding: 20px; border-radius: 8px; text-align: center;
        }
        .stat-label { font-size: 13px; color: #aaa; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #5dade2; }

        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: #5dade2; font-size: 24px; }
        h2 { margin-top: 35px; font-size: 17px; color: #f1c40f; border-left: 4px solid #f1c40f; padding-left: 12px; margin-bottom: 15px; }
        
        .table-wrapper { background: #242424; border-radius: 8px; overflow: hidden; border: 1px solid #444; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #1f1f1f; color: #888; font-weight: bold; }
        
        button { border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; padding: 6px 12px; }
        .btn-ban { background: #e74c3c; color: white; }
        .btn-dismiss { background: #555; color: white; margin-left: 5px; }
        .btn-unban { background: #2ecc71; color: white; }
        .btn-refresh { background: #4a90e2; color: white; padding: 10px 20px; }
        .btn-toggle { background: #9b59b6; color: white; padding: 10px 20px; margin-right: 10px; } /* í™”ë©´ ì „í™˜ ë²„íŠ¼ ìƒ‰ìƒ */
        
        .ban-form { 
            background: #252525; padding: 20px; border-radius: 8px; 
            display: flex; gap: 10px; align-items: center; border: 1px solid #444; margin-bottom: 20px;
        }
        .ban-form input { 
            padding: 10px; background: #1a1a1a; border: 1px solid #444; 
            color: #eee; border-radius: 4px; flex: 1; 
        }

        .badge-ip { font-family: monospace; background: #444; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .time-text { color: #777; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1>âš™ï¸ Dtactics Chat Administration</h1>
        <div>
            <button class="btn-toggle" id="toggleBtn" onclick="toggleView()">ì±„íŒ… ê¸°ë¡ ë³´ê¸° ğŸ’¬</button>
            <button class="btn-refresh" onclick="loadData()">ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
        </div>
    </div>

    <div id="main-view">
        <div class="admin-stats">
            <div class="stat-box">
                <div class="stat-label">ìƒíƒœ</div>
                <div class="stat-value" id="server-status" style="color: #2ecc71;">ONLINE</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ì‹ ê³  ë‚´ì—­</div>
                <div class="stat-value" id="stat-reports">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ì°¨ë‹¨ ìˆ˜</div>
                <div class="stat-value" id="stat-bans">0</div>
            </div>
        </div>
       <h2>ğŸ“¢ ê³µì§€ì‚¬í•­ ì„¤ì • (Notice)</h2>
        <div class="ban-form">
            <input type="text" id="notice-input" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš© ì…ë ¥ (ë¹„ì›Œë‘ê³  ë³€ê²½ ì‹œ ê³µì§€ ì‚­ì œ)">
            <button class="btn-refresh" style="padding: 10px 20px;" onclick="updateNotice()">ê³µì§€ ë³€ê²½</button>
        </div>
        <h2>ğŸš« IP ì°¨ë‹¨ (Manual Ban)</h2>
        <div class="ban-form">
            <input type="text" id="manualIp" placeholder="ì°¨ë‹¨í•  IP ì£¼ì†Œ">
            <input type="text" id="manualNick" placeholder="ëŒ€ìƒ ë‹‰ë„¤ì„(ì„ íƒ)">
            <input type="text" id="manualReason" placeholder="ì°¨ë‹¨ ì‚¬ìœ ">
            <button class="btn-ban" style="padding: 10px 20px;" onclick="manualBan()">ì¦‰ì‹œ ì°¨ë‹¨</button>
        </div>

        <h2>ğŸ“¢ ìµœê·¼ ì‹ ê³  ë‚´ì—­ (Reports)</h2>
        <div class="table-wrapper">
            <table id="reportTable">
                <thead>
                    <tr><th>ëŒ€ìƒ ìœ ì €</th><th>IP ì£¼ì†Œ</th><th>ì‹ ê³ ì</th><th>ë‚ ì§œ</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h2>ğŸ”’ IP ì°¨ë‹¨ ëª©ë¡ (Banned IPs)</h2>
        <div class="table-wrapper">
            <table id="banTable">
                <thead>
                    <tr><th>ë‹‰ë„¤ì„</th><th>IP ì£¼ì†Œ</th><th>ì‚¬ìœ </th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h2>ğŸ”‡ ì‹¤ì‹œê°„ ë®¤íŠ¸ ëª©ë¡ (Muted Users)</h2>
        <div class="table-wrapper">
            <table id="muteTable">
                <thead>
                    <tr><th>ìœ ì € ID</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div> <div id="chat-view" style="display: none;">
        <h2>ğŸ’¬ ìµœê·¼ ì±„íŒ… ê¸°ë¡ (Chat History)</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="chatSearch" onkeyup="filterChats()" placeholder="ë‹‰ë„¤ì„, ì•„ì´ë””, IP ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰..." style="flex: 1; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: #eee; border-radius: 4px;">
        </div>
        
        <div class="table-wrapper">
            <table id="chatTable">
                <thead>
                    <tr>
                        <th style="width: 15%;">ì‹œê°„</th>
                        <th style="width: 15%;">ë‹‰ë„¤ì„ (ID)</th>
                        <th style="width: 15%;">IP ì£¼ì†Œ</th>
                        <th style="width: 40%;">ë‚´ìš©</th>
                        <th style="width: 15%; text-align: center;">ê´€ë¦¬ (ì¦‰ì‹œ ì²˜ë²Œ)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
            <button onclick="changePage(-1)" style="background: #444; color: white; padding: 6px 15px;">â—€ ì´ì „</button>
            <span id="pageInfo" style="margin: 0 20px; font-weight: bold; color: #5dade2;">1 / 1</span>
            <button onclick="changePage(1)" style="background: #444; color: white; padding: 6px 15px;">ë‹¤ìŒ â–¶</button>
        </div>
    </div> </div> <script>
let allChats = []; 
let filteredChats = []; 
let currentPage = 1;
const chatsPerPage = 30; 
let currentView = 'main'; // í˜„ì¬ ë³´ê³  ìˆëŠ” í™”ë©´ ìƒíƒœ ('main' ë˜ëŠ” 'chat')

window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const banIp = params.get('banIp');
    const banNick = params.get('banNick');
    const banId = params.get('banId');

    if (banIp) document.getElementById('manualIp').value = banIp;
    if (banNick) document.getElementById('manualNick').value = banId ? `${banNick}(${banId})` : banNick;
    if (banIp || banNick) document.getElementById('manualReason').focus();

    loadData(); 
});

// --- í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
function toggleView() {
    const mainView = document.getElementById('main-view');
    const chatView = document.getElementById('chat-view');
    const toggleBtn = document.getElementById('toggleBtn');

    if (currentView === 'main') {
        mainView.style.display = 'none';
        chatView.style.display = 'block';
        toggleBtn.innerText = 'ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë³´ê¸° ğŸ ';
        toggleBtn.style.background = '#e67e22'; // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (ì£¼í™©)
        currentView = 'chat';
    } else {
        mainView.style.display = 'block';
        chatView.style.display = 'none';
        toggleBtn.innerText = 'ì±„íŒ… ê¸°ë¡ ë³´ê¸° ğŸ’¬';
        toggleBtn.style.background = '#9b59b6'; // ë²„íŠ¼ ìƒ‰ìƒ ë³µêµ¬ (ë³´ë¼)
        currentView = 'main';
    }
}

async function loadData() {
    const pw = new URLSearchParams(window.location.search).get('pw');
    if (!pw) { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤."); window.close(); return; }

    try {
        // 1. ì‹ ê³  ëª©ë¡
        const repRes = await fetch(`/api/admin/reports?pw=${pw}`);
        const reports = await repRes.json();
        document.getElementById('stat-reports').innerText = reports.length;
        document.querySelector('#reportTable tbody').innerHTML = reports.map(r => `
            <tr>
                <td><b>${r.targetNick}</b> (${r.targetId})</td>
                <td><span class="badge-ip">${r.targetIp}</span></td>
                <td>${r.reporter}</td>
                <td class="time-text">${new Date(r.date).toLocaleString()}</td>
                <td>
                    <button class="btn-ban" onclick="quickBan('${r.targetIp}', '${r.targetId}', '${r.targetNick}')">ë°´</button>
                    <button class="btn-dismiss" onclick="deleteReport('${r._id}')">ê¸°ê°</button>
                </td>
            </tr>
        `).join('');

        // 2. ë°´ ëª©ë¡
        const banRes = await fetch(`/api/admin/bans?pw=${pw}`);
        const bans = await banRes.json();
        document.getElementById('stat-bans').innerText = bans.length;
        document.querySelector('#banTable tbody').innerHTML = bans.map(b => `
            <tr>
                <td>${b.nick || 'Unknown'}</td>
                <td><span class="badge-ip">${b.ip}</span></td>
                <td>${b.reason}</td>
                <td><button class="btn-unban" onclick="unban('${b._id}')">ì°¨ë‹¨ í•´ì œ</button></td>
            </tr>
        `).join('');

        // 3. ë®¤íŠ¸ ëª©ë¡
        const muteRes = await fetch(`/api/admin/mutes?pw=${pw}`);
        const mutes = await muteRes.json();
        const muteBody = document.querySelector('#muteTable tbody');
        if (mutes.length === 0) {
            muteBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#666;">í˜„ì¬ ë®¤íŠ¸ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            muteBody.innerHTML = mutes.map(m => `
                <tr>
                    <td><b>${m.nick}</b> (${m.id})</td>
                    <td><span style="color:#e74c3c; font-weight:bold;">MUTED</span></td>
                    <td><button class="btn-unban" onclick="unmute('${m.id}')">ë®¤íŠ¸ í•´ì œ</button></td>
                </tr>
            `).join('');
        }

        // 4. ì±„íŒ… ëª©ë¡
        const chatRes = await fetch(`/api/admin/chats?pw=${pw}`);
        allChats = await chatRes.json();
        filterChats(); 

        document.getElementById('server-status').innerText = "ONLINE";
        document.getElementById('server-status').style.color = "#2ecc71";
    } catch (e) {
        document.getElementById('server-status').innerText = "OFFLINE";
        document.getElementById('server-status').style.color = "#e74c3c";
    }
}

function filterChats() {
    const query = document.getElementById('chatSearch').value.toLowerCase();
    
    if (query) {
        filteredChats = allChats.filter(c => 
            (c.user.nick && c.user.nick.toLowerCase().includes(query)) ||
            (c.user.id && c.user.id.toLowerCase().includes(query)) ||
            (c.ip && c.ip.includes(query)) ||
            (c.content && c.content.toLowerCase().includes(query))
        );
    } else {
        filteredChats = [...allChats];
    }
    
    currentPage = 1; 
    renderChats();
}

function changePage(step) {
    const maxPage = Math.ceil(filteredChats.length / chatsPerPage) || 1;
    currentPage += step;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > maxPage) currentPage = maxPage;
    renderChats();
}

function renderChats() {
    const chatBody = document.querySelector('#chatTable tbody');
    const maxPage = Math.ceil(filteredChats.length / chatsPerPage) || 1;
    document.getElementById('pageInfo').innerText = `${currentPage} / ${maxPage} í˜ì´ì§€ (ì´ ${filteredChats.length}ê±´)`;

    if (filteredChats.length === 0) {
        chatBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">ì¡°ê±´ì— ë§ëŠ” ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    const startIndex = (currentPage - 1) * chatsPerPage;
    const pagedData = filteredChats.slice(startIndex, startIndex + chatsPerPage);

    chatBody.innerHTML = pagedData.map(c => {
        const date = new Date(c.timestamp);
        const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
        const ipStr = c.ip || 'Unknown';
        
        let contentHtml = c.type === 'image' 
            ? `<img src="${c.content}" style="max-height: 30px; border-radius: 4px;"> <span style="font-size:11px; color:#888;">(ì´ëª¨í‹°ì½˜)</span>`
            : c.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        return `
            <tr>
                <td class="time-text">${timeStr}</td>
                <td><b style="color:#5dade2;">${c.user.nick}</b><br><span style="font-size:11px; color:#888;">${c.user.id}</span></td>
                <td><span class="badge-ip">${ipStr}</span></td>
                <td style="word-break: break-all;">${contentHtml}</td>
                <td style="text-align: center;">
                    <button class="btn-dismiss" style="background: #e67e22; padding: 4px 8px; font-size: 11px;" onclick="quickMute('${c.user.id}', '${c.user.nick}')">ë®¤íŠ¸</button>
                    <button class="btn-ban" style="padding: 4px 8px; font-size: 11px;" onclick="quickBan('${ipStr}', '${c.user.id}', '${c.user.nick}')">ë°´</button>
                </td>
            </tr>
        `;
    }).join('');
}

// --- ê´€ë¦¬ì ì•¡ì…˜ í•¨ìˆ˜ë“¤ ---
async function quickMute(id, nick) {
    const pw = new URLSearchParams(window.location.search).get('pw');
    if(confirm(`${nick} ë‹˜ì„ ì¦‰ì‹œ ì±„íŒ… ê¸ˆì§€(ë®¤íŠ¸) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        const res = await fetch(`/api/admin/mute?pw=${pw}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, nick })
        });
        if(res.ok) { alert("ë®¤íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); }
    }
}

async function quickBan(ip, id, nick) {
    const pw = new URLSearchParams(window.location.search).get('pw');
    const reason = prompt(`${nick} ë‹˜ì˜ ì°¨ë‹¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”`, "ìš´ì˜ ì •ì±… ìœ„ë°˜");
    if(reason) {
        const res = await fetch(`/api/admin/ban?pw=${pw}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip, id, nick, reason })
        });
        if(res.ok) { alert("ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); }
    }
}

async function manualBan() {
    const pw = new URLSearchParams(window.location.search).get('pw');
    const ip = document.getElementById('manualIp').value.trim();
    const nick = document.getElementById('manualNick').value.trim();
    const reason = document.getElementById('manualReason').value.trim();
    if(!ip) return alert("IP ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    const res = await fetch(`/api/admin/ban?pw=${pw}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, id: 'manual', nick: nick || 'Unknown', reason: reason || 'ê´€ë¦¬ì ì§ì ‘ ì°¨ë‹¨' })
    });
    if(res.ok) { alert("IP ì°¨ë‹¨ ì™„ë£Œ"); loadData(); }
}

async function deleteReport(id) {
    const pw = new URLSearchParams(window.location.search).get('pw');
    if(confirm("ì´ ì‹ ê³ ë¥¼ ê¸°ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const res = await fetch(`/api/admin/report/${id}?pw=${pw}`, { method: 'DELETE' });
        if(res.ok) loadData();
    }
}

async function unban(dbId) {
    const pw = new URLSearchParams(window.location.search).get('pw');
    if(confirm("ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const res = await fetch(`/api/admin/ban/${dbId}?pw=${pw}`, { method: 'DELETE' });
        if(res.ok) loadData();
    }
}

async function unmute(userId) {
    const pw = new URLSearchParams(window.location.search).get('pw');
    if(confirm(`${userId} ìœ ì €ì˜ ë®¤íŠ¸ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        const res = await fetch(`/api/admin/mute/${userId}?pw=${pw}`, { method: 'DELETE' });
        if(res.ok) { alert("ë®¤íŠ¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); }
    }
}

        const adminPw = new URLSearchParams(window.location.search).get('pw');
        fetch(`/api/admin/notice?pw=${adminPw}`)
            .then(res => res.json())
            .then(data => { document.getElementById('notice-input').value = data.notice || ''; });

        // ë³€ê²½ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì„œë²„ë¡œ ì „ì†¡
        function updateNotice() {
            const val = document.getElementById('notice-input').value;
            fetch(`/api/admin/notice?pw=${adminPw}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notice: val })
            }).then(() => alert('ê³µì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!'));
}
</script>
</body>
</html>
