<!DOCTYPE html>
<html>
<head>
    <title>ì›¹ê²Œì„ ì±„íŒ…ì°½</title>
    <style>
        /* [ì‚¬ìš©ìë‹˜ì˜ ì›ë³¸ CSS ê·¸ëŒ€ë¡œ ìœ ì§€] */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #2e2e2e; font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', dotum, sans-serif; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        #wrapper { display: flex; width: 100%; height: 100%; background: #2e2e2e; position: relative; }
        #chat-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1f1f1f; }
        #messages { flex: 1; overflow-y: auto; margin: 0; padding: 4px; list-style-type: none; font-size: 13px; line-height: 1.3; color: #ddd; }
        #messages li { padding: 3px 4px; margin-bottom: 0; word-break: break-all; border-radius: 0; transition: background-color 0.1s; position: relative; } 
        #messages li:hover { background-color: #3d3d3d; }
        .my-message-bg { background-color: #242424; }
        .user-icon { width: 12px; height: 12px; margin-right: 3px; vertical-align: middle; border-radius: 2px; }
        .my-nickname { color: #5dade2; font-weight: bold; }   
        .other-nickname { color: #dfdfdf; font-weight: bold; } 
        .msg-text { color: #dfdfdf; }
        .chat-emoticon { width: 40px; height: 40px; vertical-align: middle; }
        .clickable-nick { cursor: pointer; }
        .clickable-nick:hover { color: #fff; } 
        .system-msg { color: #f39c12; font-weight: bold; font-size: 13px; }
        .whisper-msg { color: #ff9ff3; font-weight: bold; }
        #form { display: flex; padding: 0 4px; background: #3a3a3a; align-items: center; height: 30px; border: none; }
        #emo-toggle-btn { width: 26px; height: 100%; background: transparent; border: none; color: #aaa; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0; display: flex; align-items: center; justify-content: center; }
        #input { flex: 1; padding: 0 4px; background: transparent; border: none; color: #eee; height: 100%; font-size: 13px; outline: none; }
        #form button[type="submit"] { padding: 0 8px; height: 100%; background: transparent; color: #999; border: none; cursor: pointer; font-size: 13px; font-weight: bold; }
        #emo-picker { position: absolute; bottom: 34px; left: 2px; width: 210px; background: #333; border: 1px solid #111; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); padding: 5px; display: none; flex-direction: column; z-index: 100; }
        #emo-list { display: flex; flex-wrap: wrap; gap: 3px; justify-content: flex-start; min-height: 80px; align-content: flex-start; }
        #emo-list img { width: 36px; height: 36px; cursor: pointer; border: 1px solid transparent; }
        #emo-pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; font-size: 11px; color: #ccc; }
        #emo-pagination button { background: #444; border: 1px solid #222; color: #ccc; cursor: pointer; padding: 2px 5px; border-radius: 3px; font-size: 11px; }
        #user-popup { position: absolute; background: #333; border: 1px solid #111; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); padding: 5px; display: none; flex-direction: column; z-index: 101; width: 120px; }
        .up-header { font-size: 13px; color: #5dade2; font-weight: bold; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        #user-popup button { background: #444; color: #eee; border: 1px solid #222; margin: 2px 0; padding: 4px; font-size: 12px; cursor: pointer; }
        #user-list-container { width: 130px; display: flex; flex-direction: column; background: #2e2e2e; }
        #users { flex: 1; overflow-y: auto; margin: 0; padding: 5px; list-style-type: none; font-size: 13px; color: #ddd; }
        #users li { padding: 4px 2px; display: flex; align-items: center; justify-content: flex-start; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #time-tooltip { position: absolute; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; pointer-events: none; z-index: 9999; display: none; white-space: nowrap; }
        .admin-crown { font-size: 12px; margin-right: 3px; }
        .admin-btn { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="chat-container">
            <ul id="messages"></ul>
            <div id="emo-picker">
                <div id="emo-list"></div>
                <div id="emo-pagination">
                    <button id="emo-prev">â—€</button>
                    <span id="emo-page-info">1 / 1</span>
                    <button id="emo-next">â–¶</button>
                </div>
            </div>
            <div id="user-popup">
                <div class="up-header" id="up-nick"></div>
                <button id="btn-whisper">ê·“ì†ë§ ë³´ë‚´ê¸°</button>
                <button id="btn-mute" class="admin-btn" style="color:#ff6b6b;">ì±„íŒ… ê¸ˆì§€</button>
                <button id="btn-unmute" class="admin-btn" style="color:#51cf66;">ê¸ˆì§€ í•´ì œ</button>
                <button id="btn-clear" class="admin-btn" style="color:#fcc419;">ì±„íŒ…ì°½ ì²­ì†Œ</button>
            </div>
            <form id="form" onsubmit="return false;">
                <button id="emo-toggle-btn" type="button">+</button>
                <input id="input" placeholder="ì±„íŒ… ì…ë ¥." autocomplete="off" />
                <button type="submit">ì „ì†¡</button>
            </form>
        </div>
        <div id="user-list-container">
            <ul id="users"></ul>
        </div>
    </div>
    <div id="time-tooltip"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        
        // ë‚´ ì •ë³´ ì„¤ì •
        const myNick = urlParams.get('nick') || 'Guest_' + Math.floor(Math.random() * 1000);
        const myId = urlParams.get('id') || 'guest';
        let myIcon = urlParams.get('icon') || urlParams.get('con') || '';
        
        // ì•„ì´ì½˜ ê²½ë¡œ ë³´ì •
        if (myIcon.startsWith('.') || myIcon.startsWith('/')) {
            const FIXED_BASE = 'http://forceofd.org/dt/'; 
            myIcon = FIXED_BASE + myIcon.replace(/^\.\//, '').replace(/^\//, '');
        }

        const myInfo = { nick: myNick, id: myId, icon: myIcon };
        const ADMIN_IDS = ['dirtyass', 'dirtyass2']; 
        const isAdmin = ADMIN_IDS.includes(myId);

        socket.emit('join', myInfo);

        // DOM ìš”ì†Œë“¤
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const userPopup = document.getElementById('user-popup');
        const emoPicker = document.getElementById('emo-picker');
        const timeTooltip = document.getElementById('time-tooltip');
        let selectedUser = { nick: '', id: '' };

        // 1. ë©”ì‹œì§€ ì¶œë ¥ í•µì‹¬ í•¨ìˆ˜ (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ í•˜ë‚˜ë¡œ í†µí•©)
        function displayMessage(data, isWhisper = false, whisperPrefix = "") {
            const item = document.createElement('li');
            const isMe = (data.user.nick === myNick);
            if (isMe) item.classList.add('my-message-bg');

            item.setAttribute('data-time', data.timestamp || Date.now());
            item.setAttribute('data-nick', data.user.nick);

            const iconHtml = data.user.icon ? `<img src="${data.user.icon}" class="user-icon" onerror="this.style.display='none'">` : '';
            const nickClass = isMe ? 'my-nickname' : 'other-nickname';
            
            // ì´ëª¨í‹°ì½˜ì¸ì§€ í…ìŠ¤íŠ¸ì¸ì§€ êµ¬ë¶„
            let contentHtml = (data.type === 'image') 
                ? `<img src="${data.content}" class="chat-emoticon">` 
                : `<span class="msg-text">${data.content}</span>`;

            if (isWhisper) {
                item.innerHTML = `<span class="whisper-msg">${whisperPrefix}</span> <span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> &nbsp;${contentHtml}`;
            } else {
                item.innerHTML = `${iconHtml}<span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> &nbsp;${contentHtml}`;
            }

            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        // 2. ì†Œì¼“ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆì”©ë§Œ ì„ ì–¸)
        socket.on('chat history', (history) => {
            messages.innerHTML = '';
            history.forEach(data => displayMessage(data));
        });

        socket.on('chat message', (data) => displayMessage(data));

        socket.on('whisper', (data) => {
            const isMe = (data.user.nick === myNick);
            const prefix = isMe ? `[ê·“ -> ${data.targetNick}]` : `[ê·“ <- ${data.user.nick}]`;
            displayMessage(data, true, prefix);
        });

        socket.on('system message', (msg) => {
            const item = document.createElement('li');
            item.innerHTML = `<span class="system-msg">[ì•ˆë‚´] ${msg}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('clear chat', () => { messages.innerHTML = ''; });

        socket.on('user list', (users) => {
            const usersList = document.getElementById('users');
            usersList.innerHTML = '';
            users.sort((a, b) => ADMIN_IDS.includes(a.id) ? -1 : 1).forEach(user => {
                const li = document.createElement('li');
                const isMe = (user.nick === myNick);
                const crown = ADMIN_IDS.includes(user.id) ? `<span class="admin-crown">ğŸ‘‘</span>` : '';
                const icon = user.icon ? `<img src="${user.icon}" class="user-icon">` : '';
                li.innerHTML = `${crown}${icon}<span class="clickable-nick" data-nick="${user.nick}" data-id="${user.id}" style="color:${isMe ? '#5dade2' : '#dfdfdf'};">${user.nick}</span>`;
                usersList.appendChild(li);
            });
        });

        // 3. ì±„íŒ… ì „ì†¡
        document.getElementById('form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if(!text) return;

            if (text.startsWith('/w ')) {
                const parts = text.split(' ');
                if (parts.length > 2) {
                    socket.emit('whisper', { targetNick: parts[1], user: myInfo, content: parts.slice(2).join(' ') });
                }
            } else {
                socket.emit('chat message', { type: 'text', user: myInfo, content: text });
            }
            input.value = '';
            emoPicker.style.display = 'none';
        });

        // 4. í´ë¦­ ì´ë²¤íŠ¸ ë° íŒì—… ì œì–´
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('clickable-nick')) {
                const targetNick = e.target.getAttribute('data-nick');
                if (targetNick === myNick) return;
                
                selectedUser = { nick: targetNick, id: e.target.getAttribute('data-id') };
                document.getElementById('up-nick').innerText = targetNick;
                
                if (isAdmin) document.querySelectorAll('.admin-btn').forEach(b => b.style.display = 'block');
                
                userPopup.style.display = 'flex';
                userPopup.style.top = (e.pageY + 10) + 'px';
                userPopup.style.left = e.pageX + 'px';
            } else if (!userPopup.contains(e.target)) {
                userPopup.style.display = 'none';
            }
        });

        // 5. ì´ëª¨í‹°ì½˜ ë¡œì§ (ì›ë³¸ ìœ ì§€)
        let emoticonFiles = [];
        let currentEmoPage = 1;
        const EMO_PER_PAGE = 15;
        
        const renderEmoticons = () => {
            const list = document.getElementById('emo-list');
            list.innerHTML = '';
            const start = (currentEmoPage - 1) * EMO_PER_PAGE;
            const end = Math.min(start + EMO_PER_PAGE, emoticonFiles.length);
            
            for (let i = start; i < end; i++) {
                const img = document.createElement('img');
                img.src = `/emoticons/${emoticonFiles[i]}`;
                img.onclick = () => {
                    socket.emit('chat message', { type: 'image', user: myInfo, content: img.src });
                    emoPicker.style.display = 'none';
                };
                list.appendChild(img);
            }
            document.getElementById('emo-page-info').innerText = `${currentEmoPage} / ${Math.ceil(emoticonFiles.length/EMO_PER_PAGE) || 1}`;
        };

        fetch('/api/emoticons').then(res => res.json()).then(files => { emoticonFiles = files; renderEmoticons(); });
        document.getElementById('emo-toggle-btn').onclick = () => emoPicker.style.display = (emoPicker.style.display === 'flex' ? 'none' : 'flex');
        document.getElementById('emo-prev').onclick = () => { if(currentEmoPage > 1) { currentEmoPage--; renderEmoticons(); } };
        document.getElementById('emo-next').onclick = () => { if(currentEmoPage < Math.ceil(emoticonFiles.length/EMO_PER_PAGE)) { currentEmoPage++; renderEmoticons(); } };

        // 6. ê´€ë¦¬ì ì•¡ì…˜ ì—°ê²°
        document.getElementById('btn-whisper').onclick = () => { input.value = `/w ${selectedUser.nick} `; input.focus(); userPopup.style.display = 'none'; };
        document.getElementById('btn-mute').onclick = () => { socket.emit('mute user', selectedUser.id); userPopup.style.display = 'none'; };
        document.getElementById('btn-unmute').onclick = () => { socket.emit('unmute user', selectedUser.id); userPopup.style.display = 'none'; };
        document.getElementById('btn-clear').onclick = () => { socket.emit('clear chat'); userPopup.style.display = 'none'; };
    </script>
</body>
</html>
