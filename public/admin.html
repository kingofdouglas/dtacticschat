<!DOCTYPE html>
<html>
<head>
    <title>Dtactics Admin Panel</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f4f4f4; margin: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { border-bottom: 2px solid #3498db; padding-bottom: 10px; color: #2c3e50; }
        h2 { margin-top: 30px; font-size: 18px; color: #2980b9; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        tr:hover { background: #f1f1f1; }

        .btn-ban { background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-unban { background: #2ecc71; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-refresh { background: #3498db; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; float: right; }
        
        .ban-form { background: #fdf2f2; padding: 15px; border-radius: 5px; margin-top: 10px; display: flex; gap: 10px; align-items: center; }
        .ban-form input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-refresh" onclick="loadData()">ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
    <h1>ê´€ë¦¬ì íŒ¨ë„</h1>

    <h2>ğŸš« ìˆ˜ë™ IP ì°¨ë‹¨(BAN)</h2>
    <div class="ban-form">
        <input type="text" id="banIp" placeholder="ì°¨ë‹¨í•  IP">
        <input type="text" id="banNick" placeholder="ë‹‰ë„¤ì„">
        <input type="text" id="banReason" placeholder="ì°¨ë‹¨ ì‚¬ìœ ">
        <button class="btn-ban" onclick="addBan()">ì¦‰ì‹œ ì°¨ë‹¨</button>
    </div>

    <h2>ğŸ“¢ ìµœê·¼ ì‹ ê³  ë‚´ì—­</h2>
    <table id="reportTable">
        <thead>
            <tr>
                <th>ëŒ€ìƒ ìœ ì €(ID)</th>
                <th>ëŒ€ìƒ IP</th>
                <th>ì‹ ê³ ì</th>
                <th>ë‚ ì§œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>ğŸ”’ ì°¨ë‹¨ëœ ëª©ë¡ (BAN LIST)</h2>
    <table id="banTable">
        <thead>
            <tr>
                <th>ë‹‰ë„¤ì„(ID)</th>
                <th>ì°¨ë‹¨ëœ IP</th>
                <th>ì‚¬ìœ </th>
                <th>ë‚ ì§œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const pw = urlParams.get('pw');

    async function loadData() {
        if (!pw) {
            alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            location.href = "/";
            return;
        }

        try {
            // 1. ì‹ ê³  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const repRes = await fetch(`/api/admin/reports?pw=${pw}`);
            const reports = await repRes.json();
            const repBody = document.querySelector('#reportTable tbody');
            repBody.innerHTML = reports.map(r => `
                <tr>
                    <td>${r.targetNick}(${r.targetId})</td>
                    <td>${r.targetIp}</td>
                    <td>${r.reporter}</td>
                    <td>${new Date(r.date).toLocaleString()}</td>
                    <td><button class="btn-ban" onclick="quickBan('${r.targetIp}', '${r.targetId}', '${r.targetNick}')">ì¦‰ì‹œì°¨ë‹¨ / ë°´</button></td>
                </tr>
            `).join('');

            // 2. ë°´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const banRes = await fetch(`/api/admin/bans?pw=${pw}`);
            const bans = await banRes.json();
            const banBody = document.querySelector('#banTable tbody');
            banBody.innerHTML = bans.map(b => `
                <tr>
                    <td>${b.nick}(${b.id})</td>
                    <td>${b.ip}</td>
                    <td>${b.reason || 'ì‚¬ìœ  ì—†ìŒ'}</td>
                    <td>${new Date(b.date).toLocaleString()}</td>
                    <td><button class="btn-unban" onclick="unban('${b._id}')">í•´ì œ / ì–¸ë°´</button></td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    }

    // ì‹ ê³  ë‚´ì—­ì—ì„œ ë°”ë¡œ ë°´ ì²˜ë¦¬
    function quickBan(ip, id, nick) {
        if(confirm(`${nick}ë‹˜ì„ ì¦‰ì‹œ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            executeBan({ ip, id, nick, reason: "ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ì¸í•œ ì°¨ë‹¨" });
        }
    }

    // ìˆ˜ë™ í¼ìœ¼ë¡œ ë°´ ì²˜ë¦¬
    function addBan() {
        const ip = document.getElementById('banIp').value;
        const nick = document.getElementById('banNick').value;
        const reason = document.getElementById('banReason').value;
        if(!ip) return alert("IPëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        executeBan({ ip, id: 'manual', nick, reason });
    }

    // ë°´ ì‹¤í–‰ API í˜¸ì¶œ
    async function executeBan(data) {
        const res = await fetch(`/api/admin/ban?pw=${pw}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if(res.ok) {
            alert("ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadData();
        }
    }

    // ë°´ í•´ì œ API í˜¸ì¶œ
    async function unban(dbId) {
        if(confirm("ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const res = await fetch(`/api/admin/ban/${dbId}?pw=${pw}`, { method: 'DELETE' });
            if(res.ok) {
                alert("í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadData();
            }
        }
    }

    // ì´ˆê¸° ë¡œë”©
    loadData();
</script>

</body>
</html>
