<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dtactics Admin Panel</title>
    <style>
        /* ì±„íŒ…ë°© ìŠ¤íƒ€ì¼ ê³„ìŠ¹ (Dark Theme) */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #2e2e2e; color: #ddd; 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
        }
        .container { 
            max-width: 1100px; margin: 30px auto; padding: 25px; 
            background: #333; border: 1px solid #1f1f1f; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        /* ëŒ€ì‹œë³´ë“œ í†µê³„ ì„¹ì…˜ */
        .admin-stats { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-box { 
            flex: 1; background: #252525; border: 1px solid #444; 
            padding: 20px; border-radius: 8px; text-align: center;
            transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-5px); border-color: #4a90e2; }
        .stat-label { font-size: 13px; color: #aaa; margin-bottom: 8px; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; color: #5dade2; }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: #5dade2; font-size: 24px; letter-spacing: -1px; }
        
        h2 { margin-top: 35px; font-size: 17px; color: #f1c40f; border-left: 4px solid #f1c40f; padding-left: 12px; margin-bottom: 15px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-wrapper { background: #242424; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; color: #ccc; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #1f1f1f; color: #888; font-weight: bold; text-transform: uppercase; font-size: 11px; }
        tr:hover { background: #2d2d2d; }
        tr:last-child td { border-bottom: none; }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        button { border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; outline: none; }
        .btn-ban { background: #e74c3c; color: white; padding: 6px 12px; }
        .btn-ban:hover { background: #c0392b; box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
        .btn-unban { background: #2ecc71; color: white; padding: 6px 12px; }
        .btn-unban:hover { background: #27ae60; box-shadow: 0 0 8px rgba(46, 204, 113, 0.4); }
        .btn-refresh { background: #4a90e2; color: white; padding: 10px 20px; font-size: 13px; }
        .btn-refresh:hover { background: #357abd; }
        
        /* ìˆ˜ë™ ì°¨ë‹¨ í¼ */
        .ban-form { 
            background: #252525; padding: 20px; border-radius: 8px; 
            display: flex; gap: 12px; align-items: center; border: 1px solid #444; margin-bottom: 10px;
        }
        .ban-form input { 
            padding: 10px; background: #1a1a1a; border: 1px solid #444; 
            color: #eee; border-radius: 4px; flex: 1; font-size: 13px;
        }
        .ban-form input:focus { border-color: #4a90e2; }

        /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge-ip { font-family: monospace; background: #444; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .time-text { color: #777; font-size: 12px; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #2e2e2e; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1>âš™ï¸ Dtactics Chat Administration</h1>
        <button class="btn-refresh" onclick="loadData()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
    </div>

    <div class="admin-stats">
        <div class="stat-box">
            <div class="stat-label">ìƒíƒœ</div>
            <div class="stat-value" id="server-status" style="color: #2ecc71;">ONLINE</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ë¯¸ì²˜ë¦¬ ì‹ ê³ </div>
            <div class="stat-value" id="stat-reports">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ëˆ„ì  ì°¨ë‹¨</div>
            <div class="stat-value" id="stat-bans">0</div>
        </div>
    </div>

    <h2>ğŸš« ìˆ˜ë™ IP ì°¨ë‹¨ (Manual Ban)</h2>
    <div class="ban-form">
        <input type="text" id="banIp" placeholder="ì°¨ë‹¨í•  IP ì£¼ì†Œ">
        <input type="text" id="banNick" placeholder="ëŒ€ìƒ ë‹‰ë„¤ì„">
        <input type="text" id="banReason" placeholder="ì°¨ë‹¨ ì‚¬ìœ  ì…ë ¥">
        <button class="btn-ban" style="padding: 10px 25px;" onclick="addBan()">ì¦‰ì‹œ ì°¨ë‹¨ ì‹¤í–‰</button>
    </div>

    <h2>ğŸ“¢ ìµœê·¼ ì‹ ê³  ë‚´ì—­ (Reports)</h2>
    <div class="table-wrapper">
        <table id="reportTable">
            <thead>
                <tr>
                    <th>ëŒ€ìƒ ìœ ì €</th>
                    <th>IP ì£¼ì†Œ</th>
                    <th>ì‹ ê³ ì</th>
                    <th>ë‚ ì§œ/ì‹œê°„</th>
                    <th>ì¡°ì¹˜</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <h2>ğŸ”’ ì°¨ë‹¨ëœ ëª©ë¡ (Banned Users)</h2>
    <div class="table-wrapper">
        <table id="banTable">
            <thead>
                <tr>
                    <th>ë‹‰ë„¤ì„(ID)</th>
                    <th>ì°¨ë‹¨ëœ IP</th>
                    <th>ì°¨ë‹¨ ì‚¬ìœ </th>
                    <th>ë‚ ì§œ/ì‹œê°„</th>
                    <th>ì¡°ì¹˜</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const pw = urlParams.get('pw');

    async function loadData() {
        if (!pw) {
            alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            window.close();
            return;
        }

        try {
            // ì‹ ê³  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const repRes = await fetch(`/api/admin/reports?pw=${pw}`);
            const reports = await repRes.json();
            document.getElementById('stat-reports').innerText = reports.length;

            const repBody = document.querySelector('#reportTable tbody');
            if (reports.length === 0) {
                repBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                repBody.innerHTML = reports.map(r => `
                    <tr>
                        <td><b style="color:#5dade2;">${r.targetNick}</b> <span style="color:#666;">(${r.targetId})</span></td>
                        <td><span class="badge-ip">${r.targetIp}</span></td>
                        <td>${r.reporter}</td>
                        <td class="time-text">${new Date(r.date).toLocaleString()}</td>
                        <td><button class="btn-ban" onclick="quickBan('${r.targetIp}', '${r.targetId}', '${r.targetNick}')">IP ë°´</button></td>
                    </tr>
                `).join('');
            }

            // ë°´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const banRes = await fetch(`/api/admin/bans?pw=${pw}`);
            const bans = await banRes.json();
            document.getElementById('stat-bans').innerText = bans.length;

            const banBody = document.querySelector('#banTable tbody');
            if (bans.length === 0) {
                banBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">ì°¨ë‹¨ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                banBody.innerHTML = bans.map(b => `
                    <tr>
                        <td><b style="color:#e74c3c;">${b.nick}</b> <span style="color:#666;">(${b.id})</span></td>
                        <td><span class="badge-ip">${b.ip}</span></td>
                        <td>${b.reason || 'ì‚¬ìœ  ë¯¸ê¸°ì¬'}</td>
                        <td class="time-text">${new Date(b.date).toLocaleString()}</td>
                        <td><button class="btn-unban" onclick="unban('${b._id}')">ë°´ í•´ì œ</button></td>
                    </tr>
                `).join('');
            }
        } catch (e) {
            console.error(e);
            document.getElementById('server-status').innerText = "OFFLINE";
            document.getElementById('server-status').style.color = "#e74c3c";
        }
    }

    // ë¹ ë¥¸ IP ì°¨ë‹¨
    function quickBan(ip, id, nick) {
        const reason = prompt(`${nick}ë‹˜ì˜ ì°¨ë‹¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”`, "ìš´ì˜ ì •ì±… ìœ„ë°˜ ë° ì‹ ê³  ëˆ„ì ");
        if(reason) {
            executeBan({ ip, id, nick, reason });
        }
    }

    // ìˆ˜ë™ ì°¨ë‹¨ ì¶”ê°€
    function addBan() {
        const ip = document.getElementById('banIp').value.trim();
        const nick = document.getElementById('banNick').value.trim();
        const reason = document.getElementById('banReason').value.trim();
        
        if(!ip) return alert("ì°¨ë‹¨í•  IP ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        if(confirm(`${ip} ì£¼ì†Œë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            executeBan({ ip, id: 'manual', nick: nick || 'Unknown', reason: reason || 'ê´€ë¦¬ì ìˆ˜ë™ ì°¨ë‹¨' });
        }
    }

    // ë°´ ì‹¤í–‰ ìš”ì²­
    async function executeBan(data) {
        try {
            const res = await fetch(`/api/admin/ban?pw=${pw}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if(res.ok) {
                alert("í•´ë‹¹ IPê°€ ì„±ê³µì ìœ¼ë¡œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadData();
            }
        } catch (err) {
            alert("ì°¨ë‹¨ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ë°´ í•´ì œ ìš”ì²­
    async function unban(dbId) {
        if(confirm("ì´ ìœ ì €ì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ì ‘ì†ì„ í—ˆìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const res = await fetch(`/api/admin/ban/${dbId}?pw=${pw}`, { method: 'DELETE' });
            if(res.ok) {
                alert("ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadData();
            }
        }
    }

    // ì´ˆê¸° ì‹¤í–‰
    loadData();
    // 30ì´ˆë§ˆë‹¤ ë°ì´í„° ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadData, 30000);
</script>

</body>
</html>
