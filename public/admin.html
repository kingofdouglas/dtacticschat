<!DOCTYPE html>
<html>
<head>
    <title>Dtactics Admin Panel</title>
    <style>
        /* ì±„íŒ…ë°©ê³¼ ë™ì¼í•œ ë‹¤í¬ í…Œë§ˆ ì„¤ì • */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #2e2e2e; color: #ddd; 
            font-family: 'Malgun Gothic', sans-serif; 
        }
        .container { 
            max-width: 1000px; margin: 20px auto; padding: 20px; 
            background: #333; border: 1px solid #1f1f1f; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        h1 { border-bottom: 2px solid #4a90e2; padding-bottom: 10px; color: #5dade2; font-size: 22px; }
        h2 { margin-top: 30px; font-size: 16px; color: #f1c40f; border-left: 4px solid #f1c40f; padding-left: 10px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; background: #242424; }
        th, td { padding: 10px; border: 1px solid #444; text-align: left; }
        th { background: #1f1f1f; color: #aaa; font-weight: bold; }
        tr:hover { background: #3d3d3d; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-ban { background: #e74c3c; color: white; padding: 5px 10px; }
        .btn-ban:hover { background: #c0392b; }
        .btn-unban { background: #2ecc71; color: white; padding: 5px 10px; }
        .btn-unban:hover { background: #27ae60; }
        .btn-refresh { background: #4a90e2; color: white; padding: 8px 15px; float: right; }
        .btn-refresh:hover { background: #357abd; }
        
        /* ìƒë‹¨ ìˆ˜ë™ ì°¨ë‹¨ í¼ */
        .ban-form { 
            background: #252525; padding: 15px; border-radius: 5px; 
            margin-top: 10px; display: flex; gap: 10px; align-items: center; border: 1px solid #444;
        }
        .ban-form input { 
            padding: 8px; background: #1a1a1a; border: 1px solid #444; 
            color: #eee; border-radius: 4px; flex: 1; 
        }
        .ban-form input:focus { border-color: #4a90e2; outline: none; }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-refresh" onclick="loadData()">ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
    <h1>âš™ï¸ Dtactics ê´€ë¦¬ì íŒ¨ë„</h1>

    <h2>ğŸš« ìˆ˜ë™ IP ì°¨ë‹¨ (BAN)</h2>
    <div class="ban-form">
        <input type="text" id="banIp" placeholder="ì°¨ë‹¨í•  IP">
        <input type="text" id="banNick" placeholder="ë‹‰ë„¤ì„">
        <input type="text" id="banReason" placeholder="ì°¨ë‹¨ ì‚¬ìœ ">
        <button class="btn-ban" style="padding: 8px 20px;" onclick="addBan()">ì¦‰ì‹œ ì°¨ë‹¨</button>
    </div>

    <h2>ğŸ“¢ ìµœê·¼ ì‹ ê³  ë‚´ì—­</h2>
    <table id="reportTable">
        <thead>
            <tr>
                <th>ëŒ€ìƒ ìœ ì €(ID)</th>
                <th>ëŒ€ìƒ IP</th>
                <th>ì‹ ê³ ì</th>
                <th>ë‚ ì§œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>ğŸ”’ ì°¨ë‹¨ëœ ëª©ë¡ (BAN LIST)</h2>
    <table id="banTable">
        <thead>
            <tr>
                <th>ë‹‰ë„¤ì„(ID)</th>
                <th>ì°¨ë‹¨ëœ IP</th>
                <th>ì‚¬ìœ </th>
                <th>ë‚ ì§œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const pw = urlParams.get('pw');

    async function loadData() {
        if (!pw) {
            alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            window.close(); // ê¶Œí•œ ì—†ìœ¼ë©´ ì°½ ë‹«ê¸°
            return;
        }

        try {
            const repRes = await fetch(`/api/admin/reports?pw=${pw}`);
            const reports = await repRes.json();
            const repBody = document.querySelector('#reportTable tbody');
            repBody.innerHTML = reports.map(r => `
                <tr>
                    <td style="color:#5dade2;">${r.targetNick} (${r.targetId})</td>
                    <td>${r.targetIp}</td>
                    <td>${r.reporter}</td>
                    <td style="color:#888;">${new Date(r.date).toLocaleString()}</td>
                    <td><button class="btn-ban" onclick="quickBan('${r.targetIp}', '${r.targetId}', '${r.targetNick}')">ë°´</button></td>
                </tr>
            `).join('');

            const banRes = await fetch(`/api/admin/bans?pw=${pw}`);
            const bans = await banRes.json();
            const banBody = document.querySelector('#banTable tbody');
            banBody.innerHTML = bans.map(b => `
                <tr>
                    <td style="color:#e74c3c;">${b.nick} (${b.id})</td>
                    <td>${b.ip}</td>
                    <td>${b.reason || 'ì‚¬ìœ  ì—†ìŒ'}</td>
                    <td style="color:#888;">${new Date(b.date).toLocaleString()}</td>
                    <td><button class="btn-unban" onclick="unban('${b._id}')">í•´ì œ</button></td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function quickBan(ip, id, nick) {
        if(confirm(`${nick}ë‹˜ì„ ì¦‰ì‹œ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            executeBan({ ip, id, nick, reason: "ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ì¸í•œ ì°¨ë‹¨" });
        }
    }

    function addBan() {
        const ip = document.getElementById('banIp').value;
        const nick = document.getElementById('banNick').value;
        const reason = document.getElementById('banReason').value;
        if(!ip) return alert("IPëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        executeBan({ ip, id: 'manual', nick, reason });
    }

    async function executeBan(data) {
        const res = await fetch(`/api/admin/ban?pw=${pw}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if(res.ok) { alert("ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); }
    }

    async function unban(dbId) {
        if(confirm("ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const res = await fetch(`/api/admin/ban/${dbId}?pw=${pw}`, { method: 'DELETE' });
            if(res.ok) { alert("í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); }
        }
    }

    loadData();
</script>

</body>
</html>
