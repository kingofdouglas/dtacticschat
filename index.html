<!DOCTYPE html>
<html>
<head>
    <title>웹게임 채팅창</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #2e2e2e; font-family: 'Malgun Gothic', '맑은 고딕', dotum, sans-serif; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        #wrapper { display: flex; width: 100%; height: 100%; background: #2e2e2e; position: relative; }
        #chat-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1f1f1f; }
        
        /* ==== [수정] 폰트 사이즈 13px -> 12px ==== */
        #messages { flex: 1; overflow-y: auto; margin: 0; padding: 4px; list-style-type: none; font-size: 12px; line-height: 1.25; color: #ddd; }
        
        #messages li { padding: 2px 4px; margin-bottom: 2px; word-break: break-all; border-radius: 4px; transition: background-color 0.1s; position: relative; } 
        #messages li:hover { background-color: #3d3d3d; }
        
        /* ==== [수정] 아이콘 크기 11x11 ==== */
        .user-icon { width: 11px; height: 11px; margin-right: 3px; vertical-align: text-bottom; border-radius: 2px; }
        .my-nickname, .other-nickname, .msg-text, .clickable-nick, .whisper-msg { vertical-align: baseline; }
        
        .my-nickname { color: #5dade2; font-weight: bold; }   
        .other-nickname { color: #dfdfdf; font-weight: bold; } 
        .msg-text { color: #dfdfdf; }
        .chat-emoticon { width: 40px; height: 40px; vertical-align: middle; }

        .clickable-nick { cursor: pointer; }
        .clickable-nick:hover { color: #fff; } 
        
        .system-msg { color: #f39c12; font-weight: bold; font-size: 12px; }
        .whisper-msg { color: #ff9ff3; font-weight: bold; }

        #form { display: flex; padding: 0 4px; background: #3a3a3a; align-items: center; height: 28px; border: none; }
        #emo-toggle-btn { width: 24px; height: 100%; background: transparent; border: none; color: #aaa; cursor: pointer; font-weight: bold; font-size: 16px; padding: 0; display: flex; align-items: center; justify-content: center; }
        #emo-toggle-btn:hover { color: #fff; }
        
        /* ==== [수정] 입력창 폰트 사이즈 13px -> 12px ==== */
        #input { flex: 1; padding: 0 4px; background: transparent; border: none; color: #eee; height: 100%; font-size: 12px; outline: none; }
        #input::placeholder { color: #888; font-weight: bold; } 
        #form button[type="submit"] { padding: 0 8px; height: 100%; background: transparent; color: #999; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
        #form button[type="submit"]:hover { color: #fff; }

        #emo-picker { position: absolute; bottom: 32px; left: 2px; width: 210px; background: #333; border: 1px solid #111; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); padding: 5px; display: none; flex-direction: column; z-index: 100; }
        #emo-list { display: flex; flex-wrap: wrap; gap: 3px; justify-content: flex-start; min-height: 80px; align-content: flex-start; }
        #emo-list img { width: 36px; height: 36px; cursor: pointer; border: 1px solid transparent; }
        #emo-list img:hover { border-color: #5dade2; background: #444; }
        #emo-pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; font-size: 11px; color: #ccc; }
        #emo-pagination button { background: #444; border: 1px solid #222; color: #ccc; cursor: pointer; padding: 2px 5px; border-radius: 3px; font-size: 11px; }
        #emo-pagination button:disabled { color: #666; border-color: #333; cursor: not-allowed; background-color: transparent; }

        #user-popup { position: absolute; background: #333; border: 1px solid #111; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); padding: 5px; display: none; flex-direction: column; z-index: 101; width: 120px; }
        .up-header { font-size: 12px; color: #5dade2; font-weight: bold; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        #user-popup button { background: #444; color: #eee; border: 1px solid #222; margin: 2px 0; padding: 4px; font-size: 11px; cursor: pointer; }
        #user-popup button:hover { background: #555; }
        .admin-btn { display: none; } 

        #user-list-container { width: 130px; display: flex; flex-direction: column; background: #2e2e2e; }
        #user-list-header { display: none; } 
        
        /* ==== [수정] 유저 목록 폰트 사이즈 13px -> 12px ==== */
        #users { flex: 1; overflow-y: auto; margin: 0; padding: 5px; list-style-type: none; font-size: 12px; color: #ddd; }
        #users li { padding: 3px 2px; display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #time-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none; 
            z-index: 9999;
            display: none;
            white-space: nowrap;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="chat-container">
            <ul id="messages"></ul>
            <div id="emo-picker">
                <div id="emo-list"></div>
                <div id="emo-pagination">
                    <button id="emo-prev">◀</button>
                    <span id="emo-page-info">1 / 1</span>
                    <button id="emo-next">▶</button>
                </div>
            </div>
            <div id="user-popup">
                <div class="up-header" id="up-nick"></div>
                <button id="btn-whisper">귓속말 보내기</button>
                <button id="btn-mute" class="admin-btn" style="color:#ff6b6b;">채팅 금지</button>
                <button id="btn-unmute" class="admin-btn" style="color:#51cf66;">금지 해제</button>
                <button id="btn-clear" class="admin-btn" style="color:#fcc419;">채팅창 청소</button>
            </div>
            <form id="form" onsubmit="return false;">
                <button id="emo-toggle-btn" type="button">+</button>
                <input id="input" placeholder="채팅 입력." autocomplete="off" />
                <button type="submit">전송</button>
            </form>
        </div>
        <div id="user-list-container">
            <div id="user-list-header">접속자</div>
            <ul id="users"></ul>
        </div>
    </div>
    
    <div id="time-tooltip"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        
        const myNick = urlParams.get('nick') || 'Guest_' + Math.floor(Math.random() * 1000);
        const myId = urlParams.get('id') || 'guest';
        
        let myIcon = urlParams.get('icon') || urlParams.get('con') || '';

        if (myIcon.startsWith('./')) {
            // ★ 아래 주소를 실제 운영 중인 웹게임 도메인으로 꼭 바꿔주세요!
            const GAME_DOMAIN = 'http://여기에웹게임주소입력.com'; 
            myIcon = GAME_DOMAIN + myIcon.substring(1); 
        }

        const myInfo = { nick: myNick, id: myId, icon: myIcon };

        // ★ 실제 운영자 아이디로 꼭 바꿔주세요!
        const ADMIN_ID = 'master'; 
        const isAdmin = (myInfo.id === ADMIN_ID);

        socket.emit('join', myInfo);

        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const usersList = document.getElementById('users');
        const emoToggleBtn = document.getElementById('emo-toggle-btn');
        const emoPicker = document.getElementById('emo-picker');
        const userPopup = document.getElementById('user-popup');
        const timeTooltip = document.getElementById('time-tooltip');

        let selectedUser = { nick: '', id: '' };

        document.addEventListener('click', (e) => {
            if(!e.target.classList.contains('clickable-nick') && !userPopup.contains(e.target)) {
                userPopup.style.display = 'none';
            }
        });

        document.getElementById('wrapper').addEventListener('click', (e) => {
            if (e.target.classList.contains('clickable-nick')) {
                const targetNick = e.target.getAttribute('data-nick');
                const targetId = e.target.getAttribute('data-id');
                if (targetNick === myInfo.nick) return; 

                selectedUser = { nick: targetNick, id: targetId };
                document.getElementById('up-nick').innerText = targetNick;

                if (isAdmin) {
                    document.querySelectorAll('.admin-btn').forEach(btn => btn.style.display = 'block');
                }

                const rect = e.target.getBoundingClientRect();
                const wrapperRect = document.getElementById('wrapper').getBoundingClientRect();
                userPopup.style.top = (rect.bottom - wrapperRect.top + 5) + 'px';
                userPopup.style.left = (rect.left - wrapperRect.left) + 'px';
                userPopup.style.display = 'flex';
                emoPicker.style.display = 'none'; 
            }
        });

        document.getElementById('btn-whisper').addEventListener('click', () => {
            input.value = `/w ${selectedUser.nick} `; 
            input.focus();
            userPopup.style.display = 'none';
        });
        document.getElementById('btn-mute').addEventListener('click', () => { socket.emit('mute user', selectedUser.id); userPopup.style.display = 'none'; });
        document.getElementById('btn-unmute').addEventListener('click', () => { socket.emit('unmute user', selectedUser.id); userPopup.style.display = 'none'; });
        document.getElementById('btn-clear').addEventListener('click', () => { socket.emit('clear chat'); userPopup.style.display = 'none'; });

        let emoticonFiles = [];
        let currentEmoPage = 1;
        const EMO_PER_PAGE = 15; 
        const emoList = document.getElementById('emo-list');
        const emoPrevBtn = document.getElementById('emo-prev');
        const emoNextBtn = document.getElementById('emo-next');
        const emoPageInfo = document.getElementById('emo-page-info');

        function renderEmoticons() {
            emoList.innerHTML = ''; 
            const totalPages = Math.ceil(emoticonFiles.length / EMO_PER_PAGE) || 1;
            const startIndex = (currentEmoPage - 1) * EMO_PER_PAGE;
            const endIndex = Math.min(startIndex + EMO_PER_PAGE, emoticonFiles.length);

            for (let i = startIndex; i < endIndex; i++) {
                const file = emoticonFiles[i];
                const img = document.createElement('img');
                img.src = `/emoticons/${file}`;
                img.addEventListener('click', () => {
                    sendMessage('image', `/emoticons/${file}`);
                    emoPicker.style.display = 'none'; 
                });
                emoList.appendChild(img);
            }
            emoPageInfo.innerText = `${currentEmoPage} / ${totalPages}`;
            emoPrevBtn.disabled = currentEmoPage === 1;
            emoNextBtn.disabled = currentEmoPage === totalPages || totalPages === 0;
        }

        fetch('/api/emoticons').then(res => res.json()).then(files => { emoticonFiles = files; renderEmoticons(); }).catch(err => console.error(err));
        emoPrevBtn.addEventListener('click', () => { if (currentEmoPage > 1) { currentEmoPage--; renderEmoticons(); } });
        emoNextBtn.addEventListener('click', () => { if (currentEmoPage < Math.ceil(emoticonFiles.length / EMO_PER_PAGE)) { currentEmoPage++; renderEmoticons(); } });
        emoToggleBtn.addEventListener('click', () => { emoPicker.style.display = emoPicker.style.display === 'flex' ? 'none' : 'flex'; userPopup.style.display = 'none'; });

        function sendMessage(type, content) {
            if (!content) return;
            socket.emit('chat message', { type: type, user: myInfo, content: content });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const text = input.value.trim();
            if(text !== "") {
                if (text.startsWith('/w ')) {
                    const parts = text.split(' ');
                    if (parts.length > 2) {
                        const targetNick = parts[1];
                        const msg = parts.slice(2).join(' ');
                        socket.emit('whisper', { targetNick: targetNick, user: myInfo, content: msg });
                    }
                } else {
                    sendMessage('text', text);
                }
                input.value = '';
                emoPicker.style.display = 'none';
            }
        });

        function formatTimeDiff(timestamp) {
            const diffMs = Date.now() - timestamp;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return '방금 전';
            if (diffMins < 60) return `${diffMins}분 전`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}시간 전`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}일 전`;
        }

        let tooltipTimeout;
        let mouseX = 0;
        let mouseY = 0;

        // ==== [신규] 툴팁 스마트 포지셔닝 함수 ====
        function updateTooltipPosition() {
            const ttWidth = timeTooltip.offsetWidth;
            const ttHeight = timeTooltip.offsetHeight;
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;

            let left = mouseX + 12;
            let top = mouseY + 15; // 기본적으로 마우스 아래에 위치

            // 마우스 아래쪽 공간이 부족할 경우 위쪽으로 띄움
            if (top + ttHeight > winHeight) {
                top = mouseY - ttHeight - 10;
                if (top < 0) top = 5; // 위쪽 공간도 부족할 경우 대비
            }
            
            // 오른쪽 화면 밖으로 넘어갈 경우 방지
            if (left + ttWidth > winWidth) {
                left = winWidth - ttWidth - 10;
            }

            timeTooltip.style.left = left + 'px';
            timeTooltip.style.top = top + 'px';
        }

        messages.addEventListener('mousemove', (e) => {
            mouseX = e.pageX;
            mouseY = e.pageY;
            if (timeTooltip.style.display === 'block') {
                updateTooltipPosition();
            }
        });

        messages.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li');
            if (li && li.hasAttribute('data-time')) {
                // 아이디 대신 닉네임을 가져오도록 수정
                const sendNick = li.getAttribute('data-nick') || '알 수 없음';
                const timeStr = formatTimeDiff(parseInt(li.getAttribute('data-time')));
                
                // 지연 시간을 0.7초(700ms)로 수정
                tooltipTimeout = setTimeout(() => {
                    timeTooltip.innerText = `${sendNick} ${timeStr}`;
                    timeTooltip.style.display = 'block';
                    updateTooltipPosition(); // 창이 뜰 때 즉시 위치 조정
                }, 700);
            }
        });

        messages.addEventListener('mouseout', (e) => {
            const li = e.target.closest('li');
            if (li) {
                clearTimeout(tooltipTimeout);
                timeTooltip.style.display = 'none';
            }
        });

        socket.on('system message', (msg) => {
            const item = document.createElement('li');
            item.innerHTML = `<span class="system-msg">[안내] ${msg}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('clear chat', () => {
            messages.innerHTML = ''; 
        });

        socket.on('whisper', (data) => {
            const item = document.createElement('li');
            const isMe = (data.user.nick === myInfo.nick);
            const prefix = isMe ? `[귓속말 -> ${data.targetNick}]` : `[귓속말 <- ${data.user.nick}]`;
            const nickClass = isMe ? 'my-nickname' : 'other-nickname';

            item.setAttribute('data-time', Date.now());
            // 툴팁에서 닉네임을 사용하기 위해 data-nick 속성 추가
            item.setAttribute('data-nick', data.user.nick);

            item.innerHTML = `<span class="whisper-msg">${prefix}</span> <span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> <span class="msg-text">${data.content}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('chat message', function(data) {
            const item = document.createElement('li');
            const userIconHtml = data.user.icon ? `<img src="${data.user.icon}" class="user-icon">` : '';
            let messageContent = data.type === 'image' ? `<img src="${data.content}" class="chat-emoticon">` : `<span class="msg-text">${data.content}</span>`;
            const isMe = (data.user.nick === myInfo.nick);
            const nickClass = isMe ? 'my-nickname' : 'other-nickname';

            item.setAttribute('data-time', Date.now());
            // 툴팁에서 닉네임을 사용하기 위해 data-nick 속성 추가
            item.setAttribute('data-nick', data.user.nick);

            item.innerHTML = `${userIconHtml}<span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> <span class="msg-text">${data.content}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('user list', function(users) {
            usersList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                const iconHtml = user.icon ? `<img src="${user.icon}" class="user-icon">` : '';
                const isMe = (user.nick === myInfo.nick);
                const listNickColor = isMe ? '#5dade2' : '#dfdfdf';

                li.innerHTML = `${iconHtml}<span class="clickable-nick" data-nick="${user.nick}" data-id="${user.id}" style="color:${listNickColor};">${user.nick}</span>`;
                usersList.appendChild(li);
            });
        });
    </script>
</body>
</html>
