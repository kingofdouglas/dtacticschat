<!DOCTYPE html>
<html>
<head>
    <title>Dtactics Chat</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #2e2e2e; font-family: 'Malgun Gothic', sans-serif; box-sizing: border-box; }
        #wrapper { display: flex; width: 100%; height: 100%; position: relative; }
        #chat-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #1f1f1f; }
        #messages { flex: 1; overflow-y: auto; margin: 0; padding: 4px; list-style-type: none; font-size: 13px; color: #ddd; }
        #messages li { padding: 3px 4px; margin-bottom: 0; word-break: break-all; border-radius: 0; transition: background-color 0.1s; position: relative; } 
        #messages li:hover { background-color: #3d3d3d; }
        .my-message-bg { background-color: #242424; }
        .user-icon { width: 12px; height: 12px; margin-right: 3px; vertical-align: middle; border-radius: 2px; }
        .my-nickname { color: #5dade2; font-weight: bold; }   
        .other-nickname { color: #dfdfdf; font-weight: bold; } 
        .msg-text { color: #dfdfdf; }
        .chat-emoticon { width: 40px; height: 40px; vertical-align: middle; }
        .clickable-nick { cursor: pointer; }
        .whisper-msg { color: #ff9ff3; font-weight: bold; }
        .system-msg { color: #f1c40f; font-size: 12px; font-style: italic; }
        #resizer { width: 5px; cursor: col-resize; background: #1f1f1f; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        #resizer:hover { background: #4a90e2; }
        #resizer::after { content: "â‹®"; color: #666; font-size: 14px; font-weight: bold; }
        
        #form { display: flex; padding: 0 4px; background: #3a3a3a; align-items: center; height: 30px; }
        #emo-toggle-btn { width: 26px; height: 100%; background: transparent; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        #input { flex: 1; padding: 0 4px; background: transparent; border: none; color: #eee; height: 100%; font-size: 13px; outline: none; min-width: 0; }
        #form button[type="submit"] { background: transparent; color: #999; border: none; cursor: pointer; font-weight: bold; white-space: nowrap;}
        

        #whisper-tag { display: none; align-items: center; background: #242424; color: #ff9ff3; padding: 0 8px; margin: 0 4px; border: 1px solid #555; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap; height: 22px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); cursor: pointer; transition: background 0.2s; }
        #whisper-tag:hover { background: #333; } 
        #whisper-target-name { max-width: 80px; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
        #whisper-cancel { margin-left: 6px; color: #888; font-weight: bold; font-size: 11px; transition: color 0.2s; pointer-events: none; }
        #whisper-tag:hover #whisper-cancel { color: #ff6b6b; }

        #emo-picker { position: absolute; bottom: 32px; left: 4px; width: 185px; background: #333; border: 1px solid #111; display: none; flex-direction: column; z-index: 100; }
        #emo-list { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; padding: 4px; height: 75px; overflow: hidden; }
        #emo-list img { width: 34px; height: 34px; cursor: pointer; }
        #emo-pagination { display: flex; justify-content: space-between; align-items: center; padding: 2px 5px; background: #222; font-size: 10px; color: #ccc; }
        #emo-pagination button { background: #444; border: none; color: #fff; cursor: pointer; padding: 0 4px; }
        #user-popup { position: absolute; background: rgba(35,35,35,0.98); border: 1px solid #444; display: none; flex-direction: column; z-index: 101; min-width: 100px; padding: 5px 0; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        #user-popup button { background: transparent; color: #eee; border: none; padding: 5px 10px; font-size: 12px; cursor: pointer; text-align: left; width: 100%; }
        #user-popup button:hover { background: #4a90e2; }
        .admin-section { border-top: 1px solid #444; margin-top: 5px; padding-top: 5px; display: none; }
        .admin-row { display: flex; align-items: center; justify-content: center; padding: 2px 0; }
        .admin-row button { width: auto !important; padding: 3px 8px !important; display: inline-block !important; }
        .admin-divider { color: #666; font-size: 10px; margin: 0 2px; }
        .notice-msg { text-align: center; color: #f1c40f; font-size: 13px; margin: 8px 0;font-weight: bold; }
        #user-list-container {  width: 160px; display: flex; flex-direction: column; background: #2e2e2e; transition: width 0.2s ease-in-out; overflow: hidden; }
        #user-count-header { padding: 2px 0; font-size: 13px;  color: #ddd; background: transparent; border-bottom: 1px solid #1f1f1f; text-align: center; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;gap: 5px;min-height: 10px; white-space: nowrap;}
        #users {  flex: 1; overflow-y: auto; list-style: none; padding: 3px 3px;  margin: 0; font-size: 12px; color: #ddd;}
        #users li {padding: 3px 2px;display: flex;align-items: center;list-style: none;}
        #time-tooltip { position: absolute; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; pointer-events: none; z-index: 9999; display: none; white-space: nowrap; }
        #btn-go-admin { background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; color: #aaa; display: none; vertical-align: middle; transition: transform 0.2s; outline: none; }
        #btn-user-setup { background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; color: #aaa; outline: none; transition: transform 0.2s; vertical-align: middle; }
        #emo-toggle-btn:hover, #btn-go-admin:hover { transform: rotate(45deg); opacity: 0.8; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; }
        
        /* ğŸš¨ ì„¤ì •ì°½ ë„ˆë¹„ ì¡°ì • (100px -> 110px) ë° ë””ìì¸ ê°œì„  */
        #user-settings-modal {
            display: none; position: absolute; background: rgba(35,35,35,0.98); 
            border: 1px solid #444; padding: 8px 10px; border-radius: 8px; 
            z-index: 102; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); 
            width: 110px; color: #ddd;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="chat-container">
            <ul id="messages"></ul>
            
            <div id="emo-picker">
                <div id="emo-list"></div>
                <div id="emo-pagination">
                    <button id="emo-prev">â—€</button>
                    <span id="emo-page-info">1 / 1</span>
                    <button id="emo-next">â–¶</button>
                </div>
            </div>

            <div id="user-popup">
                <button id="btn-whisper">ê·“ì†ë§</button>
                <button id="btn-call" style="color:#ffd32a;">í˜¸ì¶œí•˜ê¸°</button>
                <button id="btn-report" style="color: #e67e22; font-weight: bold;">ì‹ ê³ í•˜ê¸°</button>
                <button id="btn-get-ip" style="color: #3498db; font-weight: bold; display: none;">IP í™•ì¸</button>
                
                <div id="admin-controls" class="admin-section">
                    <div class="admin-row">
                        <button id="btn-mute-toggle" style="color:#ff6b6b;">ì°¨ë‹¨</button>
                        <span class="admin-divider">/</span>
                        <button id="btn-ban-toggle" style="color:#e74c3c; font-weight:bold;">ë°´</button>
                    </div>
                    <button id="btn-clear" style="color:#fcc419; text-align: center;">ì „ì²´ ì²­ì†Œ</button>
                </div>
            </div>

            <div id="user-settings-modal" style="display: none; position: absolute; background: rgba(35,35,35,0.98); border: 1px solid #444; padding: 6px 8px; border-radius: 8px; z-index: 102; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); color: #ddd; width: max-content;">
            <div style="display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 11px; color: #5dade2; margin-bottom: 6px; border-bottom: 1px solid #444; padding-bottom: 4px;">
                <span style="margin-right: 20px;">ë‚´ ì„¤ì •</span>
                <span id="close-settings-btn" style="cursor: pointer; color: #888; font-size: 12px; line-height: 1;">âœ–</span>
            </div>
            
            <label style="display: flex; align-items: center; margin-bottom: 4px; font-size: 11px; cursor: pointer;">
                <input type="checkbox" id="set-notify" checked style="margin-right: 6px;"> í˜¸ì¶œ ì•Œë¦¼
            </label>
            <label style="display: flex; align-items: center; margin-bottom: 4px; font-size: 11px; cursor: pointer;">
                <input type="checkbox" id="set-whisper" checked style="margin-right: 6px;"> ê·“ì†ë§
            </label>
            <label style="display: flex; align-items: center; margin-bottom: 4px; font-size: 11px; cursor: pointer;" title="300ì¤„ì´ ë„˜ì–´ê°€ë©´ ê³¼ê±° ëŒ€í™”ë¥¼ ì§€ì›ë‹ˆë‹¤.">
                <input type="checkbox" id="set-auto-clear" checked style="margin-right: 6px;"> ìë™ ì •ë¦¬
            </label>
            <div style="text-align: right; margin-top: 5px;">
                <button id="btn-local-clear" style="padding: 3px 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold;">í™”ë©´ ì²­ì†Œ</button>
            </div>
        </div>

            <form id="form" onsubmit="return false;">
                <button id="emo-toggle-btn" type="button">+</button>
                
                <div id="whisper-tag">
                    <span id="whisper-target-name"></span>
                    <span id="whisper-cancel" title="ê·“ì†ë§ ì·¨ì†Œ">x</span>
                </div>

                <input id="input" placeholder="ì±„íŒ….." autocomplete="off" />
                <button type="submit">ì „ì†¡</button>
                <button id="btn-user-setup" type="button" title="ë‚´ ì„¤ì •">â˜°</button>
                <button id="btn-go-admin" type="button">âš™ï¸</button>
            </form>
        </div>
        <div id="resizer"></div>
        <div id="user-list-container">
            <div id="user-count-header">ğŸ‘¤ <span id="user-count-num">0</span></div>
            <ul id="users"></ul>
        </div>
    </div>

    <audio id="call-sound" src="/call.mp3" preload="auto"></audio>
    <div id="time-tooltip"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const myNick = urlParams.get('nick') || 'Guest_' + Math.floor(Math.random() * 100);
        const myId = (urlParams.get('id') || '').trim();
        const myAid = (urlParams.get('aid') || '').trim();
        let myIcon = urlParams.get('icon') || urlParams.get('con') || '';

        const fixPath = (p) => (p && (p.startsWith('.') || p.startsWith('/'))) ? 'http://forceofd.org/dt/' + p.replace(/^\.?\//, '') : p;
        myIcon = fixPath(myIcon);
        
        const myInfo = { nick: myNick, id: myId, icon: myIcon, aid: myAid };
        let isAdmin = false;
        let selectedUser = null;
        const localMutedIds = new Set();
        const callCooldowns = {};

        let activeWhisperTarget = null;
        const whisperTag = document.getElementById('whisper-tag');
        const whisperTargetName = document.getElementById('whisper-target-name');

        function setWhisperMode(targetNick) {
            activeWhisperTarget = targetNick;
            whisperTargetName.innerText = targetNick;
            whisperTag.style.display = 'flex';
            document.getElementById('input').focus();
        }

        let isBannedState = false;
        let isKicked = false;
        let reloadTimer;
        
        socket.on('duplicate login', () => {
            isKicked = true;
        });
        
        if (!myId) {
            isKicked = true; 
            document.body.innerHTML = `<div style="color:#e74c3c; text-align:center; padding-top:50px; font-weight:bold; font-size:16px;">âš ï¸ ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>`;
            socket.disconnect(); 
        } else {
            socket.on('connect', () => {
                clearTimeout(reloadTimer);
                socket.emit('join', myInfo);
            });
        }

        socket.on('disconnect', () => {
            if (isKicked) { 
                console.log("âš ï¸ ë‹¤ë¥¸ ê³³ì—ì„œ ë¡œê·¸ì¸í•˜ì—¬ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                return;
            }
            if (isBannedState) { 
                console.log("âš ï¸ ì°¨ë‹¨ë˜ì–´ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ");
                return;
            }
            reloadTimer = setTimeout(() => {
                location.reload();
            }, 3000); 
        });
        
        
        socket.on('admin auth', () => { isAdmin = true; });

        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const userPopup = document.getElementById('user-popup');
        const emoPicker = document.getElementById('emo-picker');
        const timeTooltip = document.getElementById('time-tooltip');
        
        function parseChatText(text) {
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return safeText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color: #5dade2; text-decoration: none;">${url}</a>`);
        }

        function displayMessage(data, isWhisper = false, whisperPrefix = "") {
            const item = document.createElement('li');
            if (data.user.nick === myNick) item.classList.add('my-message-bg');
            item.setAttribute('data-time', data.timestamp || Date.now());
            item.setAttribute('data-nick', data.user.nick);

            const iconHtml = data.user.icon ? `<img src="${fixPath(data.user.icon)}" class="user-icon" onerror="this.style.display='none'">` : '';
            const nickClass = (data.user.nick === myNick) ? 'my-nickname' : 'other-nickname';
            
            let contentHtml = data.type === 'image' 
                ? `<img src="${data.content}" class="chat-emoticon">` 
                : `<span class="msg-text">${parseChatText(data.content)}</span>`;

            item.innerHTML = isWhisper 
                ? `<span class="whisper-msg">${whisperPrefix}</span> <span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> ${contentHtml}`
                : `${iconHtml}<span class="${nickClass} clickable-nick" data-nick="${data.user.nick}" data-id="${data.user.id}">${data.user.nick}:</span> ${contentHtml}`;

            messages.appendChild(item);
            
            if (mySettings.autoClear && messages.children.length > 300) {
                messages.removeChild(messages.firstChild);
            }
            messages.scrollTop = messages.scrollHeight;
        }

        socket.on('admin auth', (isAdminAuth) => {
            if (isAdminAuth) {
                isAdmin = true;
                const adminBtn = document.getElementById('btn-go-admin');
                if (adminBtn) adminBtn.style.display = 'inline-block';
            }
        });
            
        const adminBtn = document.getElementById('btn-go-admin');
        if (adminBtn) {
            adminBtn.onclick = () => {
                const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                if (pw) window.open("/admin?pw=" + pw, "_blank");
            };
        }

        socket.on('chat history', (h) => {
            document.getElementById('messages').innerHTML = ''; 
            h.forEach(d => {
                if (d.type === 'whisper') {
                    const isMe = (d.user.id === myId); 
                    const replyTarget = isMe ? d.targetNick : d.user.nick;
                    const prefixText = isMe ? `[To ${d.targetNick}]` : `[From ${d.user.nick}]`;
                    const prefixHtml = `<span class="reply-btn" data-nick="${replyTarget}" style="cursor: pointer; text-decoration: none;" title="ë‹µì¥í•˜ê¸°">${prefixText}</span>`;
                    if (d.content.includes('/emoticons/')) {d.type = 'image'; }
                    displayMessage(d, true, prefixHtml);
                } else {
                    displayMessage(d);
                }
            });
        });

        socket.on('chat message', (d) => displayMessage(d));
        
        socket.on('whisper', (d) => {
            const isMe = (d.user.id === myId);
            const replyTarget = isMe ? d.targetNick : d.user.nick;
            const prefixText = isMe ? `[To ${d.targetNick}]` : `[From ${d.user.nick}]`;
            const prefixHtml = `<span class="reply-btn" data-nick="${replyTarget}" style="cursor: pointer; text-decoration: none;" title="ë‹µì¥í•˜ê¸°">${prefixText}</span>`;
            if (d.content.includes('/emoticons/')) { d.type = 'image';}
            displayMessage(d, true, prefixHtml);
        });

        socket.on('call alert', (data) => {
            document.getElementById('call-sound').play().catch(() => {});
            const item = document.createElement('li');
            item.innerHTML = `<span style="color:#ffd32a; font-weight:bold;">[í˜¸ì¶œ] ğŸ”” ${data.sender}ë‹˜ì´ ë‹¹ì‹ ì„ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤!</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });
        
        socket.on('system message', (msg) => {
            const item = document.createElement('li');
            item.innerHTML = `<span class="system-msg">${msg}</span>`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('notice message', (msg) => {
            if (!msg) return;
            const item = document.createElement('li');
            item.className = 'notice-msg';
            item.innerText = `ğŸ“¢ ${msg}`; 
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });
        
        socket.on('clear chat', () => { messages.innerHTML = ''; });

        // ğŸš¨ ì„¤ì • ê´€ë ¨ ë³€ìˆ˜ ë° ë™ì‘ ì •ì˜
        let mySettings = { notify: true, whisper: true, autoClear: true };
        const userSettingsModal = document.getElementById('user-settings-modal');
        const btnUserSetup = document.getElementById('btn-user-setup');

        socket.on('load settings', (settings) => {
            mySettings = { ...mySettings, ...settings };
            document.getElementById('set-notify').checked = mySettings.notify;
            document.getElementById('set-whisper').checked = mySettings.whisper;
            document.getElementById('set-auto-clear').checked = mySettings.autoClear;
        });

        // ğŸš¨ ë©”ë‰´ íŒì—… ìœ„ì¹˜ ê³ ì •
        btnUserSetup.onclick = () => {
            if (userSettingsModal.style.display === 'none' || userSettingsModal.style.display === '') {
                userSettingsModal.style.display = 'block';
                
                // ë²„íŠ¼ì˜ í˜„ì¬ í™”ë©´ìƒ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const rect = btnUserSetup.getBoundingClientRect();
                
                // í™”ë©´ ìš°ì¸¡ì—ì„œ ë²„íŠ¼ ìš°ì¸¡ê¹Œì§€ì˜ ê±°ë¦¬
                const rightOffset = window.innerWidth - rect.right;
                // í™”ë©´ í•˜ë‹¨ì—ì„œ ë²„íŠ¼ ìƒë‹¨ê¹Œì§€ì˜ ê±°ë¦¬ (ì´ ê°’ì„ bottomì— ì£¼ë©´ ë²„íŠ¼ ìœ„ë¡œ íŒì—…ì´ ìƒê¹ë‹ˆë‹¤)
                const bottomOffset = window.innerHeight - rect.top + 5; 

                // ê¸°ì¤€ì ì„ ìœ„(top)/ì™¼ìª½(left)ì—ì„œ ì•„ë˜(bottom)/ì˜¤ë¥¸ìª½(right)ìœ¼ë¡œ ë°”ê¿”ë²„ë¦½ë‹ˆë‹¤.
                userSettingsModal.style.top = 'auto';
                userSettingsModal.style.left = 'auto';
                userSettingsModal.style.right = rightOffset + 'px';
                userSettingsModal.style.bottom = bottomOffset + 'px';
            } else {
                userSettingsModal.style.display = 'none';
            }
        };

        document.getElementById('close-settings-btn').onclick = () => {
            userSettingsModal.style.display = 'none';
        };

        document.getElementById('btn-local-clear').onclick = () => {
            document.getElementById('messages').innerHTML = '';
            userSettingsModal.style.display = 'none';
        };

        document.getElementById('set-notify').onchange = (e) => {
            mySettings.notify = e.target.checked;
            socket.emit('update settings', mySettings);
        };

        document.getElementById('set-whisper').onchange = (e) => {
            mySettings.whisper = e.target.checked;
            socket.emit('update settings', mySettings);
        };

        document.getElementById('set-auto-clear').onchange = (e) => {
            mySettings.autoClear = e.target.checked;
            socket.emit('update settings', mySettings);
        };
        
        socket.on('user list', (users) => {
            const list = document.getElementById('users');
            list.innerHTML = '';
            document.getElementById('user-count-num').innerText = users.length;
            users.sort((a, b) => (a.isAdmin === b.isAdmin ? 0 : a.isAdmin ? -1 : 1)).forEach(u => {
                const li = document.createElement('li');
                const isMe = (u.nick === myNick);
                const crown = u.isAdmin ? 'ğŸ‘‘' : '';
                const icon = u.icon ? `<img src="${fixPath(u.icon)}" class="user-icon">` : '';
                li.innerHTML = `${crown}${icon}<span class="clickable-nick" data-nick="${u.nick}" data-id="${u.id}" style="color:${isMe ? '#5dade2' : '#dfdfdf'};">${u.nick}</span>`;
                list.appendChild(li);
            });
        });

        socket.on('banned user', function(data) {
            isBannedState = true;
            clearTimeout(reloadTimer);
            socket.disconnect();
            window.stop(); 
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('reply-btn')) {
                const targetNick = e.target.getAttribute('data-nick');
                setWhisperMode(targetNick);
                return;
            }
            if (e.target.closest('#whisper-tag')) {
                activeWhisperTarget = null;
                whisperTag.style.display = 'none';
                document.getElementById('input').focus();
                return;
            }
            if (e.target.classList.contains('clickable-nick')) {
                const nick = e.target.getAttribute('data-nick');
                const id = e.target.getAttribute('data-id');
                if (nick === myNick) return;

                selectedUser = { nick, id };

                const btnReport = document.getElementById('btn-report');
                const btnGetIp = document.getElementById('btn-get-ip');
        
                if (isAdmin) {
                    btnReport.style.display = 'none';  
                    btnGetIp.style.display = 'block'; 
                } else {
                    btnReport.style.display = 'block';
                    btnGetIp.style.display = 'none';
                }
                
                const adminControls = document.getElementById('admin-controls');
                if (isAdmin) {
                    adminControls.style.display = 'block';
                    const isMuted = localMutedIds.has(selectedUser.id);
                    document.getElementById('btn-mute-toggle').innerText = isMuted ? "í•´ì œ" : "ì±„ê¸ˆ";
                    document.getElementById('btn-ban-toggle').innerText = "ë°´";
                } else {
                    adminControls.style.display = 'none';
                }

                userPopup.style.display = 'flex'; 

                const popWidth = userPopup.offsetWidth;
                const popHeight = userPopup.offsetHeight;

                let posX = e.pageX + 10;
                if (posX + popWidth > window.innerWidth) posX = e.pageX - popWidth - 5;

                let posY = e.pageY + 10;
                if (posY + popHeight > window.innerHeight) posY = e.pageY - popHeight - 5;

                posX = Math.max(0, posX);
                posY = Math.max(0, posY);

                userPopup.style.left = posX + 'px';
                userPopup.style.top = posY + 'px';

            } else if (!userPopup.contains(e.target)) {
                userPopup.style.display = 'none';
            }
            
            if (!emoPicker.contains(e.target) && e.target.id !== 'emo-toggle-btn') emoPicker.style.display = 'none';
            
            if (userSettingsModal.style.display === 'block' && 
                !userSettingsModal.contains(e.target) && 
                e.target !== btnUserSetup) {
                userSettingsModal.style.display = 'none';
            }
        });

        document.getElementById('btn-get-ip').onclick = () => {
            if (selectedUser) socket.emit('get user ip', selectedUser.id);
            userPopup.style.display = 'none';
        };

        document.getElementById('btn-whisper').onclick = () => { 
            setWhisperMode(selectedUser.nick);
            userPopup.style.display='none'; 
        };
        
        document.getElementById('btn-call').onclick = () => {
            const now = Date.now();
            if (callCooldowns[selectedUser.id] && (now - callCooldowns[selectedUser.id] < 600000)) {
                alert('í˜¸ì¶œì€ 10ë¶„ì— í•œ ë²ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            } else {
                callCooldowns[selectedUser.id] = now;
                socket.emit('call user', { targetNick: selectedUser.nick, sender: myNick });
            }
            userPopup.style.display='none';
        };

        document.getElementById('btn-report').onclick = () => {
            if (confirm(`${selectedUser.nick}ë‹˜ì„ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                socket.emit('report user', { id: selectedUser.id, nick: selectedUser.nick });
                alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            userPopup.style.display='none';
        };
        
        document.getElementById('btn-mute-toggle').onclick = () => {
            const isCurrentlyMuted = localMutedIds.has(selectedUser.id);
            if (isCurrentlyMuted) {
                socket.emit('unmute user', selectedUser.id);
                localMutedIds.delete(selectedUser.id);
            } else {
                socket.emit('mute user', selectedUser.id);
                localMutedIds.add(selectedUser.id);
            }
            userPopup.style.display='none';
        };

        document.getElementById('btn-ban-toggle').onclick = () => {
            if (confirm(`${selectedUser.nick}ë‹˜ì„ ë°´ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚¬ìœ  ì…ë ¥ì„ ìœ„í•´ ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) {
                socket.emit('get ip for ban', selectedUser.id);
            }
            userPopup.style.display = 'none';
        };

        socket.on('open ban page', (data) => {
            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pw) {
                const url = `/admin?pw=${pw}&banIp=${encodeURIComponent(data.ip)}&banId=${encodeURIComponent(data.id)}&banNick=${encodeURIComponent(data.nick)}`;
                window.open(url, "_blank");
            }
        });

        let emos = []; let pg = 1;
        let recentEmos = JSON.parse(localStorage.getItem('recentEmos') || '[]');

        const drawEmos = () => {
            const list = document.getElementById('emo-list');
            list.innerHTML = '';
            const otherEmos = emos.filter(f => !recentEmos.includes(f));
            const sortedEmos = [...recentEmos, ...otherEmos];
            sortedEmos.slice((pg-1)*10, pg*10).forEach(f => {
                const img = document.createElement('img');
                img.src = `/emoticons/${f}`;
                img.onclick = () => {
                    if (activeWhisperTarget) {
                        socket.emit('whisper', { targetNick: activeWhisperTarget, user: myInfo, content: img.src });
                    } else {
                        socket.emit('chat message', { type:'image', user:myInfo, content:img.src });
                    }
                    recentEmos = [f, ...recentEmos.filter(e => e !== f)].slice(0, 10);
                    localStorage.setItem('recentEmos', JSON.stringify(recentEmos));
                    drawEmos();
                    emoPicker.style.display = 'none';
                };
                list.appendChild(img);
            });
            document.getElementById('emo-page-info').innerText = `${pg}/${Math.ceil(sortedEmos.length/10) || 1}`;
        };

        fetch('/api/emoticons').then(r => r.json()).then(f => { emos = f; drawEmos(); });
        document.getElementById('emo-toggle-btn').onclick = () => emoPicker.style.display = (emoPicker.style.display==='flex'?'none':'flex');
        document.getElementById('emo-prev').onclick = () => { if(pg>1){ pg--; drawEmos(); } };
        document.getElementById('emo-next').onclick = () => { if(pg < Math.ceil(emos.length/10)){ pg++; drawEmos(); } };

        // ğŸš¨ í¼ ì „ì†¡ ì´ë²¤íŠ¸
        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = input.value.trim();
            if(!val) return;
            
            if (val === '/ì²­ì†Œ') {
                document.getElementById('messages').innerHTML = ''; 
                input.value = ''; 
                return; 
            }

            if (activeWhisperTarget) {
                socket.emit('whisper', { targetNick: activeWhisperTarget, user: myInfo, content: val });
            } 
            else if (val.startsWith('/w ')) {
                let targetNick = "";
                let content = "";
                if (val.startsWith('/w "')) {
                    const endQuoteIdx = val.indexOf('"', 4);
                    if (endQuoteIdx !== -1) {
                        targetNick = val.substring(4, endQuoteIdx);
                        content = val.substring(endQuoteIdx + 1).trim();
                    }
                } else {
                    const p = val.split(' ');
                    targetNick = p[1];
                    content = p.slice(2).join(' ');
                }

                if (targetNick && content) {
                    socket.emit('whisper', { targetNick: targetNick, user: myInfo, content: content });
                }
            } 
            else {
                socket.emit('chat message', { type: 'text', user: myInfo, content: val });
            }
            
            input.value = '';
            emoPicker.style.display = 'none';
        };

        const resizer = document.getElementById('resizer');
        const userListCont = document.getElementById('user-list-container');
        let isResizing = false;
        resizer.addEventListener('mousedown', () => { 
            isResizing = true; 
            document.body.style.userSelect = 'none'; 
            userListCont.style.transition = 'none'; 
        });
        document.addEventListener('mousemove', (e) => {
            if (isResizing) {
                const offsetRight = document.body.offsetWidth - e.pageX;
                if (offsetRight > 80 && offsetRight < 400) userListCont.style.width = offsetRight + 'px';
            }
            mouseX = e.pageX; mouseY = e.pageY;
        });
        document.addEventListener('mouseup', () => { 
            isResizing = false; 
            document.body.style.userSelect = 'auto'; 
            userListCont.style.transition = ''; 
        });

        let mouseX, mouseY, tooltipTimeout;
        
        function formatTimeDiff(rawTime) {
            const ts = new Date(rawTime).getTime(); 
            const m = Math.floor((Date.now() - ts) / 60000);
            if (isNaN(m) || m < 0) return 'ë°©ê¸ˆ ì „'; 
            if (m < 1) return 'ë°©ê¸ˆ ì „';
            if (m < 60) return `${m}ë¶„ ì „`;
            if (m < 1440) return `${Math.floor(m/60)}ì‹œê°„ ì „`;
            return `${Math.floor(m/1440)}ì¼ ì „`;
        }
        
        messages.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li');
            if (li && li.hasAttribute('data-time')) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    const rawTime = li.getAttribute('data-time'); 
                    timeTooltip.innerText = `${li.getAttribute('data-nick')} ${formatTimeDiff(rawTime)}`;
                    timeTooltip.style.display = 'block';
                    timeTooltip.style.left = (mouseX + 15) + 'px';
                    timeTooltip.style.top = (mouseY + 15) + 'px';
                }, 700);
            }
        });
        messages.addEventListener('mouseout', () => { clearTimeout(tooltipTimeout); timeTooltip.style.display = 'none'; });

        let lastUserListWidth = '160px'; 
        let isUserListOpen = true;
        
        document.getElementById('user-count-header').onclick = () => {
            const container = document.getElementById('user-list-container');
            const usersUl = document.getElementById('users'); 
            const resizer = document.getElementById('resizer');
            
            if (isUserListOpen) {
                lastUserListWidth = container.style.width || '160px';
                container.style.width = '35px';
                usersUl.style.display = 'none';
                resizer.style.visibility = 'hidden';
                isUserListOpen = false;
            } else {
                container.style.width = lastUserListWidth;
                resizer.style.visibility = 'visible';
                isUserListOpen = true;
                usersUl.style.display = 'block';
            }
        };

        let errorReloadCount = parseInt(sessionStorage.getItem('err_reload_count') || '0');
        if (errorReloadCount < 3) {
            window.addEventListener('error', function(e) {
                sessionStorage.setItem('err_reload_count', errorReloadCount + 1);
                setTimeout(() => location.reload(), 2000); 
            });
            setTimeout(() => { sessionStorage.setItem('err_reload_count', '0'); }, 10000);
        }
    </script>
</body>
</html>






